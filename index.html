<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    /* Reset & base */
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0 }
    body {
      font-family:'Noto Sans Thai',sans-serif;
      background:#f0f2f5;
      display:flex; justify-content:center; align-items:flex-start;
      padding:40px 0;
    }
    .container { max-width:480px; width:100%; padding:0 16px; }

    /* Header */
    h1 { font-size:2.2rem; color:#1a237e; text-align:center; margin-bottom:4px; }
    .subtitle { font-size:0.9rem; color:#666; text-align:center; margin-bottom:4px; }
    .history  { font-size:1rem; color:#444; text-align:center; margin-bottom:24px; }

    /* Tabs */
    .tabs { display:flex; margin-bottom:24px; border-radius:8px; overflow:hidden;
            box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .tabs button {
      flex:1; padding:12px; font-size:1rem; font-weight:600;
      border:none; background:#e0e0e0; cursor:pointer; transition:background .3s;
    }
    .tabs button.active { background:#3949ab; color:#fff }
    .tabs button:not(.active):hover { background:#d5d5d5 }

    /* Cards */
    .card {
      background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      padding:24px; margin-bottom:24px;
      transition:transform .2s;
    }
    .card:hover { transform:translateY(-2px) }

    /* Start buttons */
    .button-group { display:flex; gap:16px }
    .btn {
      flex:1; padding:14px; font-size:1rem; font-weight:600; color:#fff;
      border:none; border-radius:8px; cursor:pointer;
      transition:background .3s, box-shadow .3s;
    }
    .btn-video {
      background:linear-gradient(45deg,#43a047,#66bb6a);
      box-shadow:0 4px 8px rgba(67,160,71,0.3);
    }
    .btn-video:hover { background:linear-gradient(45deg,#388e3c,#57a05a); }
    .btn-quiz {
      background:linear-gradient(45deg,#1e88e5,#42a5f5);
      box-shadow:0 4px 8px rgba(30,136,229,0.3);
    }
    .btn-quiz:hover { background:linear-gradient(45deg,#1565c0,#1e7ae1); }

    /* Quiz */
    #quiz-card, #result-card { display:none; }
    #quiz-card img {
      width:100%; border-radius:8px;
      margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    #progress {
      height:8px; background:#e0e0e0;
      border-radius:4px; overflow:hidden; margin-bottom:16px;
    }
    #progress-bar {
      height:100%; background:#1e88e5;
      width:0; transition:width .4s ease;
    }
    .question {
      font-size:1.4rem; font-weight:bold;
      color:#1a237e; margin-bottom:16px;
    }
    .choices label {
      display:block; font-size:1.1rem;
      margin-bottom:12px; padding:12px; border-radius:6px;
      background:#f7f7f7; cursor:pointer; transition:background .3s;
    }
    .choices label:hover { background:#ececec; }
    .choices input {
      margin-right:10px; transform:scale(1.2);
    }

    /* Submit button */
    #submitBtn {
      display:none; width:100%; padding:12px;
      font-size:1.1rem; font-weight:600; color:#fff;
      background:#5e35b1; border:none; border-radius:8px;
      cursor:pointer; margin-top:16px; transition:background .3s;
    }
    #submitBtn:hover { background:#512da8; }

    /* Modal */
    .modal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center; z-index:1000;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px;
      max-width:300px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content p { margin-bottom:16px; font-size:1.1rem; }
    .modal-content button {
      padding:10px 20px; font-size:1rem; font-weight:600;
      color:#fff; background:#1e88e5; border:none; border-radius:6px;
      cursor:pointer; transition:background .3s;
    }
    .modal-content button:hover { background:#1565c0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</h1>
    <div class="subtitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
    <div id="quiz-history" class="history">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</div>

    <div class="tabs">
      <button class="active" data-level="general">Quiz ‡∏™‡πÇ‡∏ï‡∏£‡∏Å (10)</button>
      <button data-level="asm">Quiz ‡∏≠‡∏™‡∏°. (20)</button>
    </div>

    <div id="start-card" class="card">
      <div class="button-group">
        <button id="btnVideo" class="btn btn-video">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        <button id="btnQuiz"  class="btn btn-quiz">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
      </div>
    </div>

    <div id="quiz-card" class="card">
      <img id="infographic" src="" alt="Infographic"/>
      <div id="progress"><div id="progress-bar"></div></div>
      <div id="questionText" class="question"></div>
      <div id="choicesContainer" class="choices"></div>
      <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <div id="result-card" class="card">
      <h2 style="margin-top:0">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="scoreText" style="font-size:1.2rem;"></p>
      <p id="wrongText" style="font-size:1rem;color:#c62828;"></p>
    </div>
  </div>

  <div id="answerModal" class="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <button id="modalNextBtn">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
 <script>
  const GAS_URL = 'https://script.google.com/macros/s/.../exec';
  const LIFF_ID = '2005789397-ROQvjpYk';
  let userProfile, level = 'general', questions = [], idx = 0, score = 0, wrongs = [];
  let historyData = [];

  // 1) CALLBACK: history JSONP
  window.handleHistory = data => {
    historyData = data || [];
    const startCard = document.getElementById('start-card');
    // first time?
    if (!historyData.length) {
      startCard.innerHTML = `
        <div class="intro" style="margin-bottom:16px; text-align:center;">
          <p>‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞</p>
          <p>‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô</p>
          <p>‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡∏à‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÇ‡∏£‡∏Ñ‡∏≠‡∏±‡∏°‡∏û‡∏≤‡∏ï</p>
          <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ ‚Üì</p>
        </div>
        <div class="button-group">
          <button id="btnVideo" class="btn btn-video">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
          <button id="btnQuiz"  class="btn btn-quiz">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>`;
      attachStartButtons();
    } else {
      // have history: get last score & fetch user name
      const last     = historyData[historyData.length-1];
      const full     = last.full_score;
      const scoreVal = last.score;
      // ask Apps Script for the display name
      const s = document.createElement('script');
      s.src = `${GAS_URL}?action=getUserName&userId=${userProfile.userId}&callback=handleUserName`;
      document.head.appendChild(s);
      // store last for use in handleUserName
      window._lastScore = { score: scoreVal, full: full };
    }
  };

  // 2) CALLBACK: after fetching user name
  window.handleUserName = resp => {
    const nameObj  = resp.name || '‡∏Ñ‡∏∏‡∏ì‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
    const { score: sc, full } = window._lastScore || {};
    const startCard = document.getElementById('start-card');
    let introHtml;

    if (sc < full) {
      introHtml = `
        <div class="intro" style="margin-bottom:16px; text-align:center;">
          <p>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <strong>${sc}/${full}</strong></p>
          <p>‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${full} ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞ ‚Üì</p>
        </div>`;
    } else {
      introHtml = `
        <div class="intro" style="margin-bottom:16px; text-align:center;">
          <p>‡∏Ñ‡∏∏‡∏ì ${nameObj} ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß üéâ</p>
          <p>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏° ‚Üì</p>
        </div>`;
    }

    startCard.innerHTML = introHtml + `
      <div class="button-group">
        <button id="btnVideo" class="btn btn-video">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        <button id="btnQuiz"  class="btn btn-quiz">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
      </div>`;
    attachStartButtons();
  };

  // wire up the two start buttons after we overwrite innerHTML
  function attachStartButtons() {
    document.getElementById('btnQuiz').onclick = () => {
      const s = document.createElement('script');
      s.src = `${GAS_URL}?action=getQuiz&level=${level}&callback=handleQuiz`;
      document.head.appendChild(s);
    };
    document.getElementById('btnVideo').onclick = () => {
      window.open('https://youtu.be/your_video_url','_blank');
      setTimeout(()=>document.getElementById('btnQuiz').click(), 500);
    };
  }

  // ‚Ä¶ your existing init(), getQuiz callback, showQuestion(), etc. ‚Ä¶

  // at end of <script>:
  document.addEventListener('DOMContentLoaded', async () => {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
    userProfile = await liff.getProfile();
    loadHistory();
  });

  function loadHistory() {
    if (!userProfile?.userId) return;
    const s = document.createElement('script');
    s.src = `${GAS_URL}?action=getHistory&userId=${userProfile.userId}&level=${level}&callback=handleHistory`;
    document.head.appendChild(s);
  }
</script>
</body>
</html>
