<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap"
        rel="stylesheet"/>
  <style>
    /* Global */
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:'Noto Sans Thai',sans-serif;
      font-size:18px;  /* larger for seniors */
      background:#f0f2f5;
      display:flex; justify-content:center;
      padding:40px 0;
    }
    .container { max-width:480px; width:100%; padding:0 16px; }

    /* Header */
    h1 { font-size:28px; text-align:center; color:#1a237e; margin-bottom:12px; }
    #quiz-history {
      text-align:center; font-size:18px; color:#444;
      margin-bottom:16px;
    }

    /* Card */
    .card {
      background:#fff; border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      padding:20px; margin-bottom:20px;
    }

    /* Start */
    .intro { line-height:1.6; color:#333; text-align:center; margin-bottom:16px; }
    .button-group { display:flex; gap:12px; }
    .btn {
      flex:1; padding:12px; font-size:18px; font-weight:700;
      color:#fff; border:none; border-radius:6px; cursor:pointer;
      transition:background .2s,font-size .2s;
    }
    .btn-quiz {
      background:linear-gradient(45deg,#1e88e5,#42a5f5);
    }
    .btn-quiz:hover { background:linear-gradient(45deg,#1565c0,#1e7ae1); }

    /* Quiz */
    #quiz-card { display:none; }
    #progress { height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden; margin-bottom:16px; }
    #progress-bar { height:100%; width:0; background:#1e88e5; transition:width .3s; }
    .question { font-size:20px; font-weight:700; color:#1a237e; margin-bottom:16px; }
    .choices label {
      display:block; font-size:18px; margin-bottom:12px; padding:12px;
      background:#f7f7f7; border-radius:6px; cursor:pointer;
      transition:background .2s;
    }
    .choices label:hover { background:#ececec; }
    .choices input { margin-right:12px; transform:scale(1.2); }

    #submitBtn {
      display:none; width:100%; padding:12px; margin-top:16px;
      background:#5e35b1; color:#fff; border:none; border-radius:6px;
      font-size:18px; font-weight:700; cursor:pointer;
      transition:background .2s;
    }
    #submitBtn:hover { background:#512da8; }

    /* Result */
    #result-card { display:none; }
    #result-card h2 { font-size:22px; margin-bottom:12px; }
    #result-card p { font-size:18px; margin-bottom:8px; }
    #shareBtn {
      display:none; width:100%; padding:12px; margin-top:16px;
      background:linear-gradient(45deg,#fb8c00,#ffb74d);
      color:#fff; border:none; border-radius:6px;
      font-size:18px; font-weight:700; cursor:pointer;
      transition:background .2s;
    }
    #shareBtn:hover { background:linear-gradient(45deg,#f57c00,#ffa726); }

    /* Modal */
    .modal {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4);
      justify-content:center; align-items:center; z-index:1000;
    }
    .modal-content {
      background:#fff; padding:24px; border-radius:6px;
      text-align:center; width:90%; max-width:360px;
    }
    .modal-content p { font-size:20px; margin-bottom:20px; }
    .modal-content button {
      padding:10px 24px; font-size:18px; font-weight:700;
      color:#fff; background:#1e88e5; border:none; border-radius:6px;
      cursor:pointer; transition:background .2s;
    }
    .modal-content button:hover { background:#1565c0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</h1>
    <div id="quiz-history">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</div>

    <!-- Start Card -->
    <div id="start-card" class="card"></div>

    <!-- Quiz Card -->
    <div id="quiz-card" class="card">
      <div id="progress"><div id="progress-bar"></div></div>
      <div id="questionText" class="question"></div>
      <div id="choicesContainer" class="choices"></div>
      <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <!-- Result Card -->
    <div id="result-card" class="card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="scoreText"></p>
      <p id="wrongText"></p>
      <button id="shareBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
    </div>
  </div>

  <!-- Answer Modal -->
  <div id="answerModal" class="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <button id="modalNextBtn">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec';
    const LIFF_ID = '2005789397-ROQvjpYk';
    let userProfile, questions = [], idx = 0, score = 0, wrongs = [], level = 'general';
    let cachedRank = null, cachedTotal = null;

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // STEP 1: Load history
    function loadHistory() {
      if (!userProfile?.userId) return;
      const s = document.createElement('script');
      s.src = `${GAS_URL}?action=getHistory`
            + `&userId=${userProfile.userId}`
            + `&level=${level}`
            + `&callback=handleHistory`;
      document.head.appendChild(s);
    }

    window.handleHistory = data => {
      const start = document.getElementById('start-card');
      if (!data || data.length === 0) {
        document.getElementById('quiz-history').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö';
        start.innerHTML = `
          <div class="intro">
            ‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞<br/>
            ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡∏à‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÇ‡∏£‡∏Ñ‡∏≠‡∏±‡∏°‡∏û‡∏≤‡∏ï
          </div>
          <div class="button-group">
            <button id="btnQuiz" class="btn btn-quiz">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
          </div>`;
        attachStart();
      } else {
        const last = data[data.length - 1];
        document.getElementById('quiz-history').textContent =
          `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${last.score}/${last.full_score}`;
        // get user name
        window._last = last;
        const s = document.createElement('script');
        s.src = `${GAS_URL}?action=getUserName`
              + `&userId=${userProfile.userId}`
              + `&callback=handleUserName`;
        document.head.appendChild(s);
      }
    };

    window.handleUserName = resp => {
      const last = window._last;
      const nm   = resp.name || userProfile.displayName;
      const start= document.getElementById('start-card');
      const sc   = last.score, full = last.full_score;
      if (sc < full) {
        start.innerHTML = `
          <div class="intro">
            ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${sc}/${full}<br/>
            ‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${full} ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞
          </div>
          <div class="button-group">
            <button id="btnQuiz" class="btn btn-quiz">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
          </div>`;
      } else {
        start.innerHTML = `
          <div class="intro">
            ‡∏Ñ‡∏∏‡∏ì ${nm} ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß üéâ<br/>
            ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏´‡∏°
          </div>
          <div class="button-group">
            <button id="btnQuiz" class="btn btn-quiz">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
          </div>`;
      }
      attachStart();
    };

    function attachStart() {
      const b = document.getElementById('btnQuiz');
      if (!b) return;
      b.onclick = () => {
        const s = document.createElement('script');
        s.src = `${GAS_URL}?action=getQuiz`
              + `&level=${level}`
              + `&callback=handleQuiz`;
        document.head.appendChild(s);
      };
    }

    // STEP 2: Load quiz
    window.handleQuiz = data => {
      questions = data; idx=0; score=0; wrongs=[]; cachedRank=null; cachedTotal=null;
      document.getElementById('start-card').style.display = 'none';
      document.getElementById('quiz-card').style.display  = 'block';
      document.getElementById('result-card').style.display= 'none';
      showQuestion();
    };

    function showQuestion() {
      const q = questions[idx];
      // progress
      document.getElementById('progress-bar').style.width =
        `${(idx+1)/questions.length*100}%`;
      // text
      document.getElementById('questionText').textContent = q.question;
      // choices
      const ctn = document.getElementById('choicesContainer');
      ctn.innerHTML = '';
      shuffle(['choice1','choice2','choice3','choice4']).forEach(key=>{
        const lbl = document.createElement('label');
        lbl.textContent = q[key];
        lbl.onclick = ()=>{
          document.getElementById('submitBtn').style.display='block';
          document.querySelectorAll('.choices label')
            .forEach(l=>l.classList.remove('selected'));
          lbl.classList.add('selected');
        };
        ctn.appendChild(lbl);
      });
      // add radios
      ctn.querySelectorAll('label').forEach(lbl=>{
        const inp=document.createElement('input');
        inp.type='radio'; inp.name='choice'; inp.value=lbl.textContent;
        lbl.prepend(inp);
      });
      // submit
      const sb = document.getElementById('submitBtn');
      sb.style.display='none';
      sb.onclick = ()=> checkAnswer(q);
    }

    function checkAnswer(q) {
      const sel = document.querySelector('input[name="choice"]:checked');
      if(!sel) return;
      const chosen = sel.value.trim();
      const correct= q.correct_choice.trim();
      const modal  = document.getElementById('answerModal');
      const msg    = document.getElementById('modalMessage');
      if(chosen===correct){
        score++;
        msg.textContent='‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
      } else {
        wrongs.push(q.test_id);
        msg.textContent=`üòû ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${correct}`;
      }
      modal.style.display='flex';
      document.getElementById('modalNextBtn').onclick = ()=>{
        modal.style.display='none';
        idx < questions.length-1
          ? showQuestionAt(idx+1)
          : finishQuiz();
      };
    }

    function showQuestionAt(i) {
      idx=i;
      document.getElementById('submitBtn').style.display='none';
      showQuestion();
    }

    // STEP 3: finish -> auto‚Äërecord, then show share button
    function finishQuiz() {
      document.getElementById('quiz-card').style.display   = 'none';
      document.getElementById('result-card').style.display = 'block';
      document.getElementById('scoreText').textContent     =
        `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${score}/${questions.length} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
      document.getElementById('wrongText').textContent     =
        wrongs.length
          ? `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î: ${wrongs.join(',')}`
          : '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!';

      // auto-record
      const params = [
        'action=recordResult',
        `userId=${userProfile.userId}`,
        `level=${level}`,
        `score=${score}`,
        `full_score=${questions.length}`,
        'posttest=true',
        `wrong=${encodeURIComponent(wrongs.join(','))}`,
        'callback=cacheRank'
      ];
      const s = document.createElement('script');
      s.src = `${GAS_URL}?${params.join('&')}`;
      document.head.appendChild(s);
    }

    window.cacheRank = resp => {
      if (resp.status==='success') {
        cachedRank   = resp.rank;
        cachedTotal  = resp.totalPlayers;
        document.getElementById('shareBtn').style.display = 'block';
      } else {
        console.error(resp);
      }
    };

    // STEP 4: share button
    document.getElementById('shareBtn').onclick = () => {
      const name    = userProfile.displayName;
      const flex    = {
        type:'flex', altText:`${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
        contents:{
          type:'bubble', size:'kilo',
          header:{
            type:'box', layout:'vertical', backgroundColor:'#FFF9C4',
            contents:[
              { type:'text', text:`${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
                align:'center', weight:'bold', size:'lg', margin:'none' },
              { type:'text', text:'üëë', align:'center', size:'4xl', margin:'none' }
            ]
          },
          body:{
            type:'box', layout:'vertical', backgroundColor:'#FFF9C4',
            spacing:'none', paddingAll:'0px',
            contents:[
              { type:'text', text:`‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score}/${questions.length}`,
                align:'center', size:'md', weight:'bold', margin:'none' },
              { type:'text', text:`‡πÄ‡∏Å‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${cachedRank} ‡∏à‡∏≤‡∏Å ${cachedTotal}`,
                align:'center', size:'sm', color:'#666666', margin:'none' }
            ]
          },
          footer:{
            type:'box', layout:'vertical', backgroundColor:'#FFF9C4',
            spacing:'none', paddingAll:'0px',
            contents:[
              { type:'button', style:'primary',
                action:{ type:'uri', label:'‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', uri:`https://liff.line.me/${LIFF_ID}` },
                margin:'none'
              },
              { type:'button', style:'secondary',
                action:{ type:'uri', label:'‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£', uri:'https://lin.ee/mQhHzLv' },
                margin:'none'
              }
            ]
          }
        }
      };
      liff.shareTargetPicker([flex])
        .then(()=>console.log('Shared!'))
        .catch(e=>console.error(e));
    };

    // LIFF init & history
    document.addEventListener('DOMContentLoaded', async () => {
      await liff.init({ liffId:LIFF_ID });
      if(!liff.isLoggedIn()) liff.login();
      userProfile = await liff.getProfile();
      loadHistory();
    });
  </script>
</body>
</html>
