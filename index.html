<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô Stroke</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        /* --- Critical CSS (‡πÉ‡∏™‡πà‡πÉ‡∏ô head ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß) --- */
        :root { 
            --primary: #FF6B6B; --secondary: #4ECDC4; 
            --accent-1: #FFE66D; --accent-2: #1A535C;
            --bg-color: #FFFDF7; --text-color: #333;
            --font-stack: 'Kanit', sans-serif;
        }
        body { 
            font-family: var(--font-stack) !important; 
            background: var(--bg-color); margin: 0; padding: 0;
            font-size: 20px; line-height: 1.5; color: var(--text-color);
            overscroll-behavior-y: contain; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ pull-to-refresh ‡∏Ç‡∏≠‡∏á browser */
        }
        .container { max-width: 100%; padding: 20px; overflow-x: hidden; }
        h1 { font-size: 40px; text-align: center; color: var(--accent-2); margin: 10px 0 30px; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 0px var(--accent-1); }
        h2 { font-size: 32px; color: var(--accent-2); font-weight: 700; margin-bottom: 20px; }

        /* --- Video Icons Menu --- */
        .video-menu-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; 
        }
        .video-btn {
            aspect-ratio: 1 / 1;
            border-radius: 25px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; font-weight: bold; font-size: 22px; color: white;
            cursor: pointer; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s; border: 3px solid rgba(255,255,255,0.3);
        }
        .video-btn:active { transform: scale(0.95); }
        .video-btn i { font-size: 50px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .v-btn-1 { background: linear-gradient(135deg, #FF9A8B, #FF6A88); }
        .v-btn-2 { background: linear-gradient(135deg, #4ECDC4, #556270); }
        .v-btn-3 { background: linear-gradient(135deg, #A8E063, #56AB2F); }
        .v-btn-4 { background: linear-gradient(135deg, #FED373, #F15245); }

        /* --- Main Buttons --- */
        .big-btn {
            width: 100%; padding: 25px; border-radius: 20px;
            font-size: 28px; font-weight: bold; text-align: center;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; gap: 15px;
            margin-bottom: 20px; color: white; border: none;
        }
        .btn-learn { background: linear-gradient(45deg, var(--secondary), var(--accent-2)); }
        .btn-quiz { background: linear-gradient(45deg, var(--primary), #c0392b); }
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ Post-test ‡πÅ‡∏•‡πâ‡∏ß */
        .btn-quiz.completed { 
            background: linear-gradient(45deg, #27ae60, #2ecc71); 
            pointer-events: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏ã‡πâ‡∏≥ */
        }

        /* --- Lesson Carousel (Horizontal Scroll) --- */
        #lesson-section { display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */ }
        .carousel-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            gap: 15px;
            padding-bottom: 20px; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö scrollbar */
        }
        .carousel-container::-webkit-scrollbar { height: 8px; }
        .carousel-container::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }

        .lesson-slide {
            flex: 0 0 100%; /* ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏û‡∏≠‡∏î‡∏µ */
            scroll-snap-align: center;
            background: #fff;
            border-radius: 25px;
            padding: 25px;
            box-sizing: border-box;
            border: 4px solid var(--accent-1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .lesson-title { font-size: 36px; font-weight: 900; color: var(--accent-2); margin-bottom: 20px; text-align: center; }
        .lesson-image-container {
            width: 100%; aspect-ratio: 1 / 1; /* ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ */
            border-radius: 20px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px; cursor: zoom-in;
            position: relative;
        }
        .lesson-image { width: 100%; height: 100%; object-fit: cover; }
        .expand-hint { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 15px; font-size: 16px; pointer-events: none;}

        /* --- Expandable Content --- */
        details.lesson-content {
            background: #f0f8ff; border-radius: 15px;
            padding: 5px; margin-bottom: 20px;
            border: 2px solid #b3e5fc;
        }
        summary {
            font-size: 26px; font-weight: bold; color: var(--secondary);
            padding: 15px; cursor: pointer; outline: none;
        }
        .lesson-details-body { padding: 15px 20px; font-size: 24px; line-height: 1.7; }
        .lesson-details-body b { color: var(--primary); }

        /* --- Inline Lesson Quiz --- */
        .lesson-quiz-container { 
            border-top: 3px dashed #ddd; padding-top: 25px; display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ó‡∏≥ */
        }
        .quiz-question-item { margin-bottom: 30px; background: #fff3e0; padding: 20px; border-radius: 15px;}
        .quiz-q-text { font-size: 26px; font-weight: bold; color: var(--accent-2); margin-bottom: 15px; }
        .quiz-choice {
            display: block; padding: 15px 20px; margin: 10px 0;
            background: #fff; border: 3px solid #ddd; border-radius: 12px;
            font-size: 24px; font-weight: bold; cursor: pointer;
        }
        /* ‡∏ã‡πà‡∏≠‡∏ô radio button */
        .quiz-choice input { display: none; } 
        /* State ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .quiz-choice.selected { border-color: var(--secondary); background: #e0f7fa; color: var(--accent-2); }
        /* State ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏•‡∏¢ */
        .quiz-choice.correct { border-color: #2ecc71 !important; background: #d5f5e3 !important; color: #1e8449; }
        .quiz-choice.wrong { border-color: #e74c3c !important; background: #fadbd8 !important; color: #c0392b; opacity: 0.7; }
        
        .btn-submit-lesson { 
            background: var(--accent-2); color: white; width: 100%; 
            padding: 20px; border-radius: 15px; font-size: 26px; font-weight: bold; border: none;
        }

        /* --- Image Modal & Share --- */
        #imageModal { 
            display: none; position: fixed; z-index: 3000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.9); flex-direction: column;
            justify-content: center; align-items: center;
        }
        #modalImage { max-width: 95%; max-height: 70vh; border-radius: 15px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .modal-close { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 50px; font-weight: bold; cursor: pointer; }
        .btn-share {
            margin-top: 20px; background: #00C300; /* LINE Green */
            color: white; padding: 15px 30px; border-radius: 30px;
            font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px;
        }

        /* --- Loading Spinner (Minimal) --- */
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 50px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Helper --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }

    </style>
</head>
<body>

    <div class="container">
        <h1>‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô STROKE ‚ù§Ô∏è</h1>

        <div class="video-menu-grid">
            <div class="video-btn v-btn-1" onclick="sendTextMessage('‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å')">
                <i class="bi bi-music-note-beamed"></i> ‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ß‡∏µ<br>‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å
            </div>
            <div class="video-btn v-btn-2" onclick="sendTextMessage('‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£')">
                <i class="bi bi-question-circle-fill"></i> ‡∏™‡πÇ‡∏ï‡∏£‡∏Å<br>‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?
            </div>
            <div class="video-btn v-btn-3" onclick="sendTextMessage('‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å')">
                <i class="bi bi-exclamation-triangle-fill"></i> ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<br>‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á
            </div>
            <div class="video-btn v-btn-4" onclick="sendTextMessage('‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å')">
                <i class="bi bi-heart-pulse-fill"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥<br>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô
            </div>
        </div>

        <hr style="border-top: 3px dotted #ddd; margin: 30px 0;">

        <div id="btnLoadLesson" class="big-btn btn-learn" onclick="loadLessons()">
            <i class="bi bi-book-half"></i>
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å (10 ‡∏ö‡∏ó)
        </div>

        <div id="lesson-section">
            <div class="loader" id="lessonLoader"></div>
            <div class="carousel-container" id="carouselContainer">
                </div>
            <button class="big-btn" style="background:#999; margin-top:20px;" onclick="closeLessonSection()">‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>

        <div id="mainQuizBtnContainer">
            <div id="btnStartMainQuiz" class="big-btn btn-quiz" onclick="startMainQuiz()">
                <i class="bi bi-pencil-fill"></i>
                <span id="quizBtnText">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
        </div>

    </div> <div id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <img id="modalImage">
        <div class="btn-share" onclick="shareCurrent Image()">
            <i class="bi bi-share-fill"></i> ‡πÅ‡∏ä‡∏£‡πå‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà Deploy ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec'; 
        const LIFF_ID = '2005789397-ROQvjpYk';
        const LINE_OA_LINK = 'https://lin.ee/hkcrpOo';

        let userProfile = null;
        let mainTestType = 'pre'; // pre ‡∏´‡∏£‡∏∑‡∏≠ post
        let lessonsData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        let currentShareImage = ''; // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏ä‡∏£‡πå

        $(document).ready(() => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    userProfile = await liff.getProfile();
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Pre/Post Test
                    checkMainQuizHistory();
                }
            } catch (e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE");
            }
        }

        // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) ---
        function sendTextMessage(text) {
            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: text }])
                    .then(() => { console.log('message sent'); liff.closeWindow(); })
                    .catch((err) => { console.error('error', err); });
            } else {
                alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô LINE App ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            }
        }

        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Carousel & Quiz) ---

        function loadLessons() {
            $('#btnLoadLesson').hide();
            $('#lesson-section').fadeIn();
            $('#lessonLoader').show();
            $('#carouselContainer').empty(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å GAS
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getLessons' },
                success: function(data) {
                    lessonsData = data;
                    renderLessons(data);
                    $('#lessonLoader').hide();
                },
                error: function() {
                    $('#lessonLoader').hide();
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ');
                    closeLessonSection();
                }
            });
        }

        function renderLessons(lessons) {
            let html = '';
            lessons.forEach((lesson, index) => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á level ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‡πÄ‡∏ä‡πà‡∏ô lesson1, lesson2...
                const lessonLevel = `lesson${index + 1}`;
                // ‡πÉ‡∏ä‡πâ loading="lazy" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
                html += `
                <div class="lesson-slide" id="module-${lesson.module_id}">
                    <div class="lesson-title">${lesson.title}</div>
                    <div class="lesson-image-container" onclick="openModal('${lesson.images}')">
                        <img class="lesson-image" src="${lesson.images}" loading="lazy" alt="${lesson.title}">
                        <div class="expand-hint"><i class="bi bi-arrows-angle-expand"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢</div>
                    </div>
                    <details class="lesson-content">
                        <summary>‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ <i class="bi bi-caret-down-fill"></i></summary>
                        <div class="lesson-details-body">${lesson.content_html}</div>
                    </details>
                    
                    <div class="big-btn btn-quiz" style="font-size:24px; padding:15px;" onclick="loadLessonQuiz(this, '${lessonLevel}', '${lesson.module_id}')">
                        <i class="bi bi-clipboard-check"></i> ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ (3 ‡∏Ç‡πâ‡∏≠)
                    </div>
                    <div class="lesson-quiz-container" id="quiz-${lessonLevel}">
                        <div class="text-center"><div class="loader" style="display:block; width:40px; height:40px; margin: 20px auto;"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö...</div>
                    </div>
                </div>
                `;
            });
            $('#carouselContainer').html(html);
        }

        function closeLessonSection() {
            $('#lesson-section').hide();
            $('#btnLoadLesson').show();
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á scroll
            $('#carouselContainer').scrollLeft(0);
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢: ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏ó ---
        function loadLessonQuiz(btnElement, level, moduleId) {
            const quizContainer = $(btnElement).next('.lesson-quiz-container');
            $(btnElement).hide(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ó‡∏≥
            quizContainer.show(); // ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö

            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getQuiz', level: level },
                success: function(questions) {
                    renderLessonQuiz(quizContainer, questions, level, moduleId);
                }
            });
        }

        function renderLessonQuiz(container, questions, level, moduleId) {
            if (questions.length === 0) {
                container.html('<div class="text-center" style="color:red; font-size:22px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</div>');
                return;
            }
            let html = '';
            questions.forEach((q, idx) => {
                // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                let choices = ['choice1', 'choice2', 'choice3', 'choice4'].filter(k => q[k]);
                choices.sort(() => Math.random() - 0.5);

                html += `<div class="quiz-question-item" data-correct="${q.correct_choice}" data-testid="${q.test_id}">
                    <div class="quiz-q-text">${idx+1}. ${q.question}</div>`;
                choices.forEach(key => {
                    html += `<label class="quiz-choice" onclick="selectChoice(this)">
                                <input type="radio" name="q_${level}_${idx}" value="${q[key]}"> ${q[key]}
                             </label>`;
                });
                html += `</div>`;
            });
            html += `<button class="btn-submit-lesson" onclick="submitLessonQuiz(this, '${level}', ${questions.length}, '${moduleId}')">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>`;
            container.html(html);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ)
        window.selectChoice = (element) => {
           // ‡∏´‡∏≤ container ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö class selected ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
           $(element).closest('.quiz-question-item').find('.quiz-choice').removeClass('selected');
           // ‡πÄ‡∏û‡∏¥‡πà‡∏° class selected ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
           $(element).addClass('selected');
        }

        function submitLessonQuiz(btnBtn, level, fullScore, moduleId) {
            const quizContainer = $(btnBtn).parent();
            let score = 0;
            let wrongIds = [];
            let allAnswered = true;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¢
            quizContainer.find('.quiz-question-item').each(function() {
                const correctVal = $(this).data('correct').trim();
                const testId = $(this).data('testid');
                const selected = $(this).find('input:checked');
                
                if (selected.length === 0) { allAnswered = false; return false; } // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö

                const userVal = selected.val().trim();
                const selectedLabel = selected.parent();

                if (userVal === correctVal) {
                    score++;
                    selectedLabel.addClass('correct');
                } else {
                    wrongIds.push(testId);
                    selectedLabel.addClass('wrong');
                    // ‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å
                    $(this).find(`input[value="${correctVal}"]`).parent().addClass('correct');
                }
                // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                $(this).find('.quiz-choice').css('pointer-events', 'none');
            });

            if (!allAnswered) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            $(btnBtn).hide(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            quizContainer.append(`<div style="text-align:center; font-size:32px; font-weight:bold; margin:20px 0; color: var(--accent-2);">
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: <span style="color:${score===fullScore?'#2ecc71':'#e74c3c'}">${score} / ${fullScore}</span>
            </div>`);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á GAS
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: {
                    action: 'recordLessonResult', userId: userProfile.userId, name: userProfile.displayName,
                    level: level, score: score, full_score: fullScore, wrong_ids: wrongIds.join(','), moduleId: moduleId
                },
                success: (resp) => { console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
            });
        }


        // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Modal ‡πÅ‡∏•‡∏∞ Share Image ---
        function openModal(imgUrl) {
            currentShareImage = imgUrl;
            $('#modalImage').attr('src', imgUrl);
            $('#imageModal').css('display', 'flex').hide().fadeIn(300);
        }

        function closeModal() {
            $('#imageModal').fadeOut(300);
        }
        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
        $('#imageModal').click(function(e) {
             if(e.target === this) closeModal();
        });

        function shareCurrent Image() {
            if (!liff.isApiAvailable('shareTargetPicker')) {
                alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå"); return;
            }
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ
            const flexMessage = {
                type: "flex",
                altText: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡∏µ‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏°‡∏≤‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö",
                contents: {
                    type: "bubble",
                    hero: { type: "image", url: currentShareImage, size: "full", aspectRatio: "1:1", aspectMode: "cover", action: { type: "uri", uri: LINE_OA_LINK } },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "text", text: "üëÜ ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", weight: "bold", size: "md", align: "center", color: "#1A535C" },
                            { type: "button", action: { type: "uri", label: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà LINE OA ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô Stroke", uri: LINE_OA_LINK }, style: "primary", color: "#FF6B6B", margin: "md" }
                        ]
                    }
                }
            };

            liff.shareTargetPicker([flexMessage])
                .then(res => { if (res) alert("‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); closeModal(); })
                .catch(err => { console.error(err); alert("‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); });
        }


        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Main Quiz (Pre/Post) ---
        function checkMainQuizHistory() {
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'checkHistory', userId: userProfile.userId },
                success: function(data) {
                    if (data.hasTakenPost) {
                        mainTestType = 'completed';
                        $('#quizBtnText').html(`‚úÖ ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß<br>‡πÑ‡∏î‡πâ ${data.lastScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
                        $('#btnStartMainQuiz').addClass('completed').removeAttr('onclick');
                    } else {
                        mainTestType = 'pre'; // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô pre ‡∏´‡∏£‡∏∑‡∏≠ post ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                        $('#quizBtnText').html("‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏ß‡∏±‡∏î‡∏ú‡∏• (Pre/Post Test)");
                    }
                }
            });
        }

        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤ Quiz ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)
        function startMainQuiz() {
           if(mainTestType === 'completed') return;
           alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏• (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°)");
           // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ quiz.html ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á Quiz Interface ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ
           // window.location.href = "quiz.html"; 
        }

    </script>
</body>
</html>