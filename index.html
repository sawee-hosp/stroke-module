<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet"/>
<style>
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
  body,button,label,input{font-family:'Noto Sans Thai',sans-serif!important}
  body{background:#f0f2f5;display:flex;justify-content:center;padding:40px 0}
  .container{width:100%;max-width:480px;padding:0 16px}
  h1{text-align:center;font-size:28px;color:#1a237e;margin-bottom:16px}

  /* History Card */
  #history-card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);
    padding:20px;text-align:center;margin-bottom:24px;min-height:120px;display:flex;
    align-items:center;justify-content:center;font-size:20px;color:#333}

  /* Grid of 4 cards */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
  .card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);
    padding:20px;text-align:center;cursor:pointer;min-height:140px;display:flex;
    flex-direction:column;justify-content:center;transition:transform .2s}
  .card:hover{transform:translateY(-4px)}
  .card.active{border:2px solid #1e88e5;background:#e8f0fe}
  .emoji{font-size:36px;margin-bottom:8px}
  .title{font-size:18px;font-weight:700;color:#333}

  /* Quiz Card */
  #quiz-card,#result-card,#learn-card,#asm-guide{display:none}
  #quiz-card{min-height:500px;padding-top:20px}
  #progress{position:relative;height:8px;background:#e0e0e0;border-radius:4px;margin:0 0 16px}
  #progress-bar{height:100%;width:0;background:#1e88e5;transition:width .3s}
  #qindex{position:absolute;top:-4px;left:50%;transform:translateX(-50%);font-size:14px;font-weight:700;color:#333}
  .question{font-size:28px;font-weight:700;color:#1a237e;margin:24px 0}
  .choices label{display:block;font-size:22px;padding:12px;background:#f7f7f7;
    border-radius:6px;margin-bottom:12px;cursor:pointer;transition:background .2s;text-align:left}
  .choices label:hover{background:#ececec}
  .choices label.selected{background:#d1eaff;border:1px solid #1e88e5;}
  .choices input{margin-right:12px;transform:scale(1.2)}
  #submitBtn{display:none;width:100%;padding:12px;margin-top:16px;
    background:#5e35b1;color:#fff;border:none;border-radius:6px;font-size:18px;font-weight:700;
    cursor:pointer;transition:background .2s}
  #submitBtn:hover{background:#512da8}
  .link-note{font-size:14px;color:#666;margin-top:12px;text-align:left}
  .link-note span{color:#1e88e5;cursor:pointer;text-decoration:underline;}

  /* Result Card */
  #result-card{min-height:500px;padding-top:20px;text-align:center}
  .result-emoji{font-size:64px;margin-bottom:16px}
  .result-message{font-size:22px;line-height:1.6}
  #shareBtn{display:none;width:100%;padding:12px;margin-top:24px;
    background:linear-gradient(45deg,#fb8c00,#ffb74d);color:#fff;border:none;border-radius:6px;
    font-size:18px;font-weight:700;cursor:pointer;transition:background .2s}
  #shareBtn:hover{background:linear-gradient(45deg,#f57c00,#ffa726)}

  /* Modal (Answer & Info) */
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.5);display:none;justify-content:center;
    align-items:center;z-index:1000}
  .modal.show {display: flex;}
  .modal-content{background:#fff;padding:24px;border-radius:8px;
    max-width: calc(100% - 32px); width:400px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.15);}
  .modal-emoji{font-size:64px;margin-bottom:16px}
  .modal-text{font-size:24px;margin-bottom:24px}
  .modal-content button{width:100%; padding:10px 24px;font-size:18px;font-weight:700;
    color:#fff;background:#1e88e5;border:none;border-radius:6px;cursor:pointer;transition:.2s}
  .modal-content button:hover{background:#1565c0}
  .modal-content button.close-btn {background-color: #f44336; margin-top: 10px;}
  .modal-content button.close-btn:hover {background-color: #d32f2f;}

  /* Accordion */
  .accordion{margin:16px 0}
  .accordion-item:not(:last-child){border-bottom:1px solid #ddd}
  .accordion-header{padding:12px;font-size:18px;font-weight:700;cursor:pointer;
    background:#e3f2fd;display:flex;justify-content:space-between;align-items:center}
  .accordion-header.active{background:#bbdefb}
  .accordion-header .icon{font-size:20px; transition: transform 0.2s;}
  .accordion-header.active .icon{transform: rotate(45deg);}
  .accordion-body{padding:12px;font-size:16px;line-height:1.6;display:none; border-top: 1px solid #ddd;}
</style>
</head>
<body>
<div class="container">
  <h1>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</h1>

  <div id="history-card">
    <div id="history-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>

  <div class="grid">
    <div id="cardGeneralQuiz" class="card"><div class="emoji">‚ùì</div><div class="title">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div></div>
    <div id="cardGeneralLearn" class="card"><div class="emoji">üìñ</div><div class="title">‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</div></div>
    <div id="cardAsmQuiz" class="card"><div class="emoji">ü©∫</div><div class="title">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡∏≠‡∏™‡∏°.</div></div>
    <div id="cardAsmGuide" class="card"><div class="emoji">üìã</div><div class="title">‡πÅ‡∏ô‡∏ß‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏≠‡∏™‡∏°.</div></div>
  </div>

  <div id="quiz-card" class="card">
    <div id="progress"><span id="qindex">1/10</span><div id="progress-bar"></div></div>
    <div id="questionText" class="question"></div>
    <div id="choicesContainer" class="choices"></div>
    <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    <div class="link-note">‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à? <span id="openLearn">‡∏Å‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span></div>
  </div>

  <div id="result-card" class="card">
    <div id="resultEmoji" class="result-emoji"></div>
    <div id="resultMessage" class="result-message"></div>
    <button id="shareBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
  </div>
</div>

<div id="answerModal" class="modal">
  <div class="modal-content">
    <div id="modalEmoji" class="modal-emoji"></div>
    <div id="modalMessage" class="modal-text"></div>
    <button id="modalNextBtn">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
  </div>
</div>

<div id="learn-card" class="modal">
  <div class="modal-content" style="max-height:80vh;overflow:auto;text-align:left">
    <h2>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
    <div class="accordion">
      <div class="accordion-item"><div class="accordion-header">1. ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‚Äú‡∏™‡πÇ‡∏ï‡∏£‡∏Å‚Äù<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á ‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡∏µ‡∏ö/‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏Å ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏™‡∏°‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏°‡∏û‡∏§‡∏Å‡∏©‡πå ‡∏≠‡∏±‡∏°‡∏û‡∏≤‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ</p></div></div>
      <div class="accordion-item"><div class="accordion-header">2. ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á<span class="icon">Ôºã</span></div><div class="accordion-body"><p><strong>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ:</strong> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô, ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á, ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà, ‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô, ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢<br><strong>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:</strong> ‡∏≠‡∏≤‡∏¢‡∏∏, ‡πÄ‡∏û‡∏®, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</p></div></div>
      <div class="accordion-item"><div class="accordion-header">3. ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô BEFAST<span class="icon">Ôºã</span></div><div class="accordion-body"><ul style="padding-left:1em"><li><strong>B</strong> (Balance): ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã</li><li><strong>E</strong> (Eyes): ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô</li><li><strong>F</strong> (Face): ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß</li><li><strong>A</strong> (Arm): ‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á</li><li><strong>S</strong> (Speech): ‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î</li><li><strong>T</strong> (Time): ‡∏£‡∏µ‡∏ö‡πÇ‡∏ó‡∏£ 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li></ul></div></div>
    </div>
    <button id="closeLearn" class="close-btn">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<div id="asm-guide" class="modal">
  <div class="modal-content" style="max-height:80vh;overflow:auto;text-align:left">
    <h2>‡πÅ‡∏ô‡∏ß‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏≠‡∏™‡∏°.‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
     <div class="accordion">
       <div class="accordion-item"><div class="accordion-header">1. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡∏≠‡∏™‡∏°. ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô) ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p></div></div>
       <div class="accordion-item"><div class="accordion-header">2. ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô BEFAST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</p></div></div>
       <div class="accordion-item"><div class="accordion-header">3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å BEFAST ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ö‡πÇ‡∏ó‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏à‡∏±‡∏î‡∏ó‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡∏≠‡∏ô‡∏£‡∏≤‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p></div></div>
    </div>
    <button id="closeAsm" class="close-btn">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec';
const LIFF_ID='2005789397-ROQvjpYk';
let userProfile, questions = [], currentQuizLevel = '', idx = 0, score = 0, wrongs = [];
let cachedRank, cachedTotal, _name = '';

const shuffle = a => {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

function loadHistory() {
  if (!userProfile?.userId) return;
  const uid = encodeURIComponent(userProfile.userId);
  const script = document.createElement('script');
  script.src = `${GAS_URL}?action=getUserHistory&userId=${uid}&callback=handleUserHistory`;
  document.head.appendChild(script);
}

window.handleUserHistory = (data) => {
  const txt = document.getElementById('history-text');
  _name = data.name || userProfile.displayName;
  let historyMessage = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <strong>${_name}</strong>!`;
  if (data.lastScore) {
    historyMessage += `<br>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${data.lastLevel === 'asm' ? '‡∏≠‡∏™‡∏°.' : '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}) ‡πÑ‡∏î‡πâ <strong>${data.lastScore}</strong> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
  } else {
    historyMessage += `<br>‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!`;
  }
  txt.innerHTML = historyMessage;
};

function loadQuiz(level) {
  currentQuizLevel = level;
  const script = document.createElement('script');
  script.src = `${GAS_URL}?action=getQuiz&level=${level}&callback=handleQuiz`;
  document.head.appendChild(script);
}

window.handleQuiz = (data) => {
  questions = data;
  idx = 0;
  score = 0;
  wrongs = [];
  document.getElementById('quiz-card').style.display = 'block';
  showQuestion();
};

function showQuestion() {
  const q = questions[idx];
  document.getElementById('qindex').textContent = `${idx + 1}/${questions.length}`;
  document.getElementById('progress-bar').style.width = `${(idx + 1) / questions.length * 100}%`;
  document.getElementById('questionText').textContent = q.question;
  const choicesContainer = document.getElementById('choicesContainer');
  choicesContainer.innerHTML = '';
  const choices = shuffle(['choice1', 'choice2', 'choice3', 'choice4']);

  choices.forEach(key => {
    if (q[key]) {
      const label = document.createElement('label');
      label.innerHTML = `<input type="radio" name="choice" value="${q[key]}"> ${q[key]}`;
      label.onclick = () => {
        document.querySelectorAll('.choices label').forEach(l => l.classList.remove('selected'));
        label.classList.add('selected');
        document.getElementById('submitBtn').style.display = 'block';
      };
      choicesContainer.appendChild(label);
    }
  });

  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('submitBtn').onclick = () => checkAnswer(q);
}

function checkAnswer(question) {
  const selected = document.querySelector('input[name="choice"]:checked');
  if (!selected) return;

  const isCorrect = selected.value.trim() === question.correct_choice.trim();
  if (isCorrect) {
    score++;
    document.getElementById('modalEmoji').textContent = '‚úÖ';
    document.getElementById('modalMessage').textContent = '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
  } else {
    wrongs.push(question.test_id);
    document.getElementById('modalEmoji').textContent = 'üòû';
    document.getElementById('modalMessage').textContent = `‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠: ${question.correct_choice}`;
  }
  
  document.getElementById('answerModal').classList.add('show');
  document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('answerModal').classList.remove('show');
    idx++;
    if (idx < questions.length) {
      showQuestion();
    } else {
      finishQuiz();
    }
  };
}

function finishQuiz() {
  document.getElementById('quiz-card').style.display = 'none';
  document.getElementById('result-card').style.display = 'block';

  const percentage = (score / questions.length) * 100;
  let emoji, message;
  if (percentage >= 90) {
    emoji = 'üèÜ'; message = '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç!';
  } else if (percentage >= 60) {
    emoji = 'ü•à'; message = '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏õ‡∏∂‡πâ‡∏Å';
  } else {
    emoji = 'üëç'; message = '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡∏°‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡∏ô‡∏∞';
  }
  
  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultMessage').innerHTML = `<strong style="font-size:24px">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${score}/${questions.length} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong><br>${message}`;

  const params = [
    'action=recordResult',
    `userId=${encodeURIComponent(userProfile.userId)}`,
    `name=${encodeURIComponent(_name)}`,
    `level=${currentQuizLevel}`,
    `score=${score}`,
    `wrong_ids=${encodeURIComponent(wrongs.join(','))}`,
    'callback=handleRecordResult'
  ];
  const script = document.createElement('script');
  script.src = `${GAS_URL}?${params.join('&')}`;
  document.head.appendChild(script);
}

window.handleRecordResult = (resp) => {
  if (resp && resp.status === 'success') {
    cachedRank = resp.rank;
    cachedTotal = resp.totalPlayers;
    document.getElementById('shareBtn').style.display = 'block';
  }
};

window.handleShareRecord = () => {
  const name = _name || userProfile.displayName;
  const pic = userProfile.pictureUrl;

  const flex = {
    type: 'flex',
    altText: `${name} ‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
    contents: {
      type: 'bubble',
      size: 'kilo',
      header: {
        type: 'box',
        layout: 'vertical',
        backgroundColor: '#1A237E',
        paddingAll: '12px',
        contents: [
          { type: 'text', text: '‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å', align: 'center', weight: 'bold', size: 'lg', color: '#FFFFFF' }
        ]
      },
      body: {
        type: 'box',
        layout: 'vertical',
        spacing: 'md',
        paddingAll: '12px',
        alignItems: 'center',
        contents: [
          // ‚úÖ FIX: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Box Wrapper
          {
            type: 'box',
            layout: 'vertical',
            width: '100px',
            height: '100px',
            cornerRadius: '100px', // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°
            contents: [
              { type: 'image', url: pic, size: 'full', aspectMode: 'cover', aspectRatio: '1:1' }
            ]
          },
          { type: 'text', text: name, weight: 'bold', size: 'xl', margin: 'md', wrap: true, align: 'center' },
          { type: 'separator', margin: 'lg' },
          {
            type: 'box',
            layout: 'vertical',
            margin: 'lg',
            spacing: 'sm',
            contents: [
              { type: 'text', text: `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}/${questions.length}`, size: 'xl', weight: 'bold', color: '#1E88E5', align: 'center' },
              { type: 'text', text: `‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${cachedRank} ‡∏à‡∏≤‡∏Å ${cachedTotal} ‡∏Ñ‡∏ô`, size: 'sm', color: '#666666', align: 'center' }
            ]
          }
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        paddingAll: '0px',
        contents: [
          {
            type: 'button',
            style: 'primary',
            color: '#1E88E5',
            height: 'sm',
            action: { type: 'uri', label: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏ö‡πâ‡∏≤‡∏á', uri: `https://liff.line.me/${LIFF_ID}` }
          }
        ]
      }
    }
  }; // ‚úÖ FIX: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß

  if (liff.isApiAvailable('shareTargetPicker')) {
    liff.shareTargetPicker([flex]).catch(err => console.error('Share Error', err));
  } else {
    alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ö‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
  }
};


// ‚úÖ FIX: ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô DOMContentLoaded ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return; 
    }
    userProfile = await liff.getProfile();
    loadHistory();
  } catch (err) {
    console.error('LIFF Init Error:', err);
    document.getElementById('history-text').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î';
  }

  const cardHandlers = {
    'cardGeneralQuiz': () => loadQuiz('general'),
    'cardAsmQuiz': () => loadQuiz('asm'),
    'cardGeneralLearn': () => document.getElementById('learn-card').classList.add('show'),
    'cardAsmGuide': () => document.getElementById('asm-guide').classList.add('show'),
  };

  document.querySelectorAll('.grid .card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('.grid .card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      document.getElementById('quiz-card').style.display = 'none';
      document.getElementById('result-card').style.display = 'none';
      if (cardHandlers[card.id]) cardHandlers[card.id]();
    });
  });

  document.querySelectorAll('.accordion-header').forEach(header => {
    header.addEventListener('click', () => {
      const body = header.nextElementSibling;
      header.classList.toggle('active');
      body.style.display = body.style.display === 'block' ? 'none' : 'block';
    });
  });

  document.getElementById('openLearn').onclick = () => document.getElementById('learn-card').classList.add('show');
  document.getElementById('closeLearn').onclick = () => document.getElementById('learn-card').classList.remove('show');
  document.getElementById('closeAsm').onclick = () => document.getElementById('asm-guide').classList.remove('show');
  document.getElementById('shareBtn').onclick = handleShareRecord;
});
</script>

</body>
</html>