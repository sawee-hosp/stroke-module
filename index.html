<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á stroke</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        /* --- Global & Typography --- */
        :root { --primary-color: #1a237e; --secondary-color: #1e88e5; --bg-color: #f5f5f5; }
        body { 
            font-family: 'Noto Sans Thai', sans-serif !important; 
            background: var(--bg-color); 
            margin: 0; padding: 20px; 
            font-size: 22px; 
            line-height: 1.6;
            color: #333;
        }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        h1 { font-size: 36px; text-align: center; color: var(--primary-color); margin-bottom: 20px; line-height: 1.3; }
        h2 { font-size: 28px; color: var(--primary-color); margin-bottom: 20px; }

        /* --- Loading Animation (Black BG + Flashing Text) --- */
        #loading { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000000; /* ‡∏î‡∏≥‡∏™‡∏ô‡∏¥‡∏ó */
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            z-index: 2000; color: white; text-align: center; 
        }
        #loading-text { font-size: 1.5rem; margin-bottom: 10px; color: #aaa; }
        #loading-subtext { 
            font-size: 4rem; font-weight: 800; color: #ffc107; 
            min-height: 100px; line-height: 1.2; 
            text-shadow: 0 0 20px rgba(255,193,7,0.8);
            opacity: 1; transition: opacity 0.5s ease-in-out; 
        }

        /* --- Big Buttons --- */
        .menu-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .big-btn {
            background: #fff; border: 3px solid var(--secondary-color);
            border-radius: 20px; padding: 30px 20px;
            font-size: 28px; font-weight: bold; color: var(--secondary-color);
            cursor: pointer; text-align: center; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .big-btn:active { transform: scale(0.98); }
        .big-btn.primary { background: var(--secondary-color); color: #fff; border: none; }
        .big-btn i { font-size: 40px; }

        /* --- Accordion (Knowledge) --- */
        .accordion-item { border-bottom: 2px solid #ddd; margin-bottom: 10px; }
        .accordion-header {
            padding: 20px; font-size: 26px; font-weight: bold; cursor: pointer;
            background: #e3f2fd; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion-header.active { background: #bbdefb; color: var(--primary-color); }
        .accordion-body {
            padding: 20px; font-size: 24px; line-height: 1.8; display: none;
            background: #fff;
        }
        .icon { transition: 0.3s; font-size: 30px; }
        .active .icon { transform: rotate(45deg); }

        /* --- Quiz Interface --- */
        #quiz-card, #result-card, #knowledge-card { display: none; }
        .question { font-size: 32px; font-weight: bold; color: var(--primary-color); margin: 20px 0; }
        
        .choice-label {
            display: block; font-size: 26px; padding: 20px; 
            background: #f8f9fa; border: 2px solid #ddd; border-radius: 15px; 
            margin-bottom: 15px; cursor: pointer; transition: 0.2s;
        }
        .choice-label input { transform: scale(2.5); margin-right: 20px; }
        .choice-label.selected { background: #e3f2fd; border-color: var(--secondary-color); }
        
        #submitBtn {
            width: 100%; padding: 25px; font-size: 28px; 
            background: #28a745; color: white; border: none; border-radius: 15px; 
            margin-top: 20px; display: none; font-weight: bold;
        }

        /* --- Result Animation --- */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-box {
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #e8f5e9; border: 3px solid #4caf50;
            border-radius: 20px; padding: 20px; margin-top: 20px;
        }
        .rank-badge {
            font-size: 30px; color: #d35400; font-weight: bold;
            text-shadow: 1px 1px 0px #fff;
        }
        .time-text { font-size: 24px; color: #555; margin-top: 5px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 3000; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; }
        .modal-btn { width: 100%; padding: 20px; font-size: 24px; border-radius: 15px; border: none; margin-top: 15px; cursor: pointer; font-weight: bold; }
        .modal-btn.next { background: var(--secondary-color); color: white; }
        .modal-btn.close { background: #dc3545; color: white; }
    </style>
</head>
<body>

    <div id="loading">
        <div id="loading-text">‡∏à‡∏≥‡πÉ‡∏™‡πà‡πÉ‡∏à ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å:</div>
        <div id="loading-subtext"></div>
    </div>

    <div class="container">
        <div id="home-card">
            <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ<br>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Stroke</h1>
            
            <div id="user-info" style="text-align:center; font-size: 24px; margin-bottom: 30px; color: #333; background: #fff9c4; padding: 15px; border-radius: 10px;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            </div>

            <div class="menu-grid">
                <div class="big-btn" onclick="showKnowledge()">
                    <i class="bi bi-book"></i>
                    ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ<br>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å
                </div>

                <div id="startQuizBtn" class="big-btn primary" onclick="startQuiz()">
                    <i class="bi bi-pencil-square"></i>
                    <span id="quizBtnText">‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å</span>
                </div>
            </div>
        </div>

        <div id="knowledge-card">
            <h2>5 ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ! ‡∏™‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
            
            <div class="accordion-item">
                <div class="accordion-header">1. ‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?<span class="icon">Ôºã</span></div>
                <div class="accordion-body">
                    ‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á (‡∏™‡πÇ‡∏ï‡∏£‡∏Å) ‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡∏µ‡∏ö ‡∏ï‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏Å ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏™‡∏°‡∏≠‡∏á‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ
                </div>
            </div>
            
            <div class="accordion-item">
                <div class="accordion-header">2. ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<span class="icon">Ôºã</span></div>
                <div class="accordion-body">
                    - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)<br>
                    - ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô, ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á<br>
                    - ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà, ‡∏≠‡πâ‡∏ß‡∏ô‡∏•‡∏á‡∏û‡∏∏‡∏á<br>
                    - ‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">3. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ B.E.F.A.S.T.<span class="icon">Ôºã</span></div>
                <div class="accordion-body">
                    B - ‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ<br>
                    E - ‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>
                    F - ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß ‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å<br>
                    A - ‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á<br>
                    S - ‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å<br>
                    T - ‡∏£‡∏µ‡∏ö‡πÑ‡∏õ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header">4. ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï<span class="icon">Ôºã</span></div>
                <div class="accordion-body">
                    ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á ‡∏£‡∏û. ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <strong>4.5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î<br>
                    ‡πÇ‡∏ó‡∏£ 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥!
                </div>
            </div>

            <button class="modal-btn close" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <div id="quiz-card">
            <div style="font-size: 24px; font-weight: bold; color: #666; margin-bottom: 10px;">
                <span id="testTypeLabel">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>
                <span style="float:right;" id="qIndex">1/10</span>
            </div>
            <div id="questionText" class="question"></div>
            <div id="choicesContainer"></div>
            <button id="submitBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>

        <div id="result-card" style="text-align: center;">
            <div style="font-size: 60px;">üéâ</div>
            <div style="font-size: 32px; font-weight: bold;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            
            <div class="result-box">
                <div style="font-size: 26px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</div>
                <div id="resultScore" style="font-size: 50px; font-weight: bold; color: #2e7d32;">0/10</div>
            </div>

            <div class="result-box" style="border-color: #ff9800; background: #fff3e0; animation-delay: 0.3s;">
                <div class="time-text">‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
                <div id="timeTakenDisplay" style="font-size: 36px; font-weight: bold; color: #e65100;">00:00</div>
            </div>

            <div class="result-box" style="border-color: #1976d2; background: #e3f2fd; animation-delay: 0.6s;">
                <div class="rank-badge">üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà <span id="rankDisplay">...</span></div>
                <div style="font-size: 20px; color: #666;">‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalDisplay">...</span> ‡∏Ñ‡∏ô</div>
            </div>
            
            <button class="modal-btn next" onclick="closeApp()">‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</button>
        </div>
    </div>

    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <div id="fbEmoji" style="font-size: 60px;"></div>
            <div id="fbTitle" style="font-size: 32px; font-weight: bold; margin: 10px 0;"></div>
            <div id="fbMsg" style="font-size: 24px; text-align: left; margin-top: 15px;"></div>
            <button id="nextQBtn" class="modal-btn next">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec'; 
        const LIFF_ID = '2005789397-ROQvjpYk';

        let userProfile = null;
        let testType = 'pre';
        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let wrongAnswers = [];
        let userName = '';
        
        // Timer Variables
        let startTime;
        let finalTimeSec = 0;

        // --- Loading Animation ---
        function startLoadingAnim() {
            const msgs = ["‡πÄ‡∏ã‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß", "‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å", "‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å", "‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å", "‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î"];
            let i = 0;
            const sub = document.getElementById('loading-subtext');
            if(sub) sub.textContent = msgs[0];
            
            window.loadingInterval = setInterval(() => {
                if(sub) sub.style.opacity = 0;
                setTimeout(() => {
                    i = (i + 1) % msgs.length;
                    if(sub) sub.textContent = msgs[i];
                    if(sub) sub.style.opacity = 1;
                }, 500);
            }, 2500);
        }

        function stopLoadingAnim() {
            clearInterval(window.loadingInterval);
            $('#loading').fadeOut();
        }

        // --- Initialization ---
        $(document).ready(() => {
            startLoadingAnim();
            initializeLiff();
            
            // Accordion Logic
            $('.accordion-header').click(function() {
                $(this).toggleClass('active');
                $(this).next('.accordion-body').slideToggle();
            });
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    userProfile = await liff.getProfile();
                    checkUserHistory();
                }
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE");
                stopLoadingAnim();
            }
        }

        function checkUserHistory() {
            $.ajax({
                url: GAS_URL,
                dataType: 'jsonp',
                data: {
                    action: 'checkHistory',
                    userId: userProfile.userId
                },
                success: function(data) {
                    stopLoadingAnim();
                    userName = data.name || userProfile.displayName;
                    
                    let msg = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <strong>${userName}</strong>`;
                    if (data.hasTaken) {
                        // Format date nicely
                        const d = new Date(data.lastDate);
                        const dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
                        msg += `<br>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ <strong>${data.lastScore}</strong><br><span style="font-size:18px">‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${dateStr}</span>`;
                        
                        testType = 'post';
                        $('#quizBtnText').html("‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Post-test)");
                    } else {
                        testType = 'pre';
                        $('#quizBtnText').html("‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Pre-test)");
                    }
                    $('#user-info').html(msg);
                },
                error: function() {
                    stopLoadingAnim();
                    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
                }
            });
        }

        // --- UI Navigation ---
        window.showKnowledge = () => {
            $('#home-card').hide();
            $('#knowledge-card').show();
        };

        window.startQuiz = () => {
            $('#home-card').hide();
            $('#loading').show();
            
            $.ajax({
                url: GAS_URL,
                dataType: 'jsonp',
                data: {
                    action: 'getQuiz',
                    level: 'asm'
                },
                success: function(data) {
                    $('#loading').hide();
                    questions = data;
                    currentIdx = 0;
                    score = 0;
                    wrongAnswers = [];
                    
                    $('#quiz-card').show();
                    $('#testTypeLabel').text(testType === 'pre' ? "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
                    
                    // Start Timer
                    startTime = new Date();
                    
                    renderQuestion();
                }
            });
        };

        // --- Quiz Logic ---
        function renderQuestion() {
            const q = questions[currentIdx];
            $('#qIndex').text(`${currentIdx + 1} / ${questions.length}`);
            $('#questionText').text(q.question);
            
            let choices = ['choice1', 'choice2', 'choice3', 'choice4'];
            choices.sort(() => Math.random() - 0.5);

            let html = '';
            choices.forEach(key => {
                if(q[key]) {
                    html += `<label class="choice-label">
                                <input type="radio" name="ans" value="${q[key]}">
                                ${q[key]}
                             </label>`;
                }
            });
            $('#choicesContainer').html(html);
            $('#submitBtn').hide();

            $('.choice-label').click(function() {
                $('.choice-label').removeClass('selected');
                $(this).addClass('selected');
                $(this).find('input').prop('checked', true);
                $('#submitBtn').show();
            });

            $('#submitBtn').off('click').click(() => checkAnswer(q));
        }

        function checkAnswer(q) {
            const selectedVal = $('input[name="ans"]:checked').val();
            const correctVal = q.correct_choice.trim();
            const isCorrect = (selectedVal.trim() === correctVal);

            if (isCorrect) {
                score++;
                showFeedback(true, correctVal);
            } else {
                wrongAnswers.push(q.test_id);
                showFeedback(false, correctVal);
            }
        }

        function showFeedback(isCorrect, answerText) {
            $('#fbEmoji').text(isCorrect ? '‚úÖ' : '‚ùå');
            $('#fbTitle').text(isCorrect ? '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!' : '‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö');
            $('#fbTitle').css('color', isCorrect ? 'green' : 'red');
            
            if(!isCorrect) {
                $('#fbMsg').html(`‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠:<br><strong>${answerText}</strong>`);
            } else {
                $('#fbMsg').text('');
            }

            $('#feedbackModal').addClass('show');
            
            $('#nextQBtn').off('click').click(() => {
                $('#feedbackModal').removeClass('show');
                currentIdx++;
                if(currentIdx < questions.length) {
                    renderQuestion();
                } else {
                    finishQuiz();
                }
            });
        }

        function finishQuiz() {
            // Stop Timer
            let endTime = new Date();
            let timeDiff = endTime - startTime; // in ms
            finalTimeSec = Math.floor(timeDiff / 1000); // in seconds
            
            // Calculate mm:ss for display
            let minutes = Math.floor(finalTimeSec / 60);
            let seconds = finalTimeSec % 60;
            let timeStr = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;

            $('#quiz-card').hide();
            $('#loading').show();

            // Save Result
            $.ajax({
                url: GAS_URL,
                dataType: 'jsonp',
                data: {
                    action: 'recordResult',
                    userId: userProfile.userId,
                    name: userName,
                    level: 'asm',
                    score: score,
                    full_score: questions.length,
                    wrong_ids: wrongAnswers.join(','),
                    test_type: testType,
                    time_taken: finalTimeSec // Send seconds to server
                },
                success: function(resp) {
                    $('#loading').hide();
                    $('#result-card').show();
                    
                    $('#resultScore').text(`${score} / ${questions.length}`);
                    $('#timeTakenDisplay').text(timeStr);
                    
                    // Show Rank
                    $('#rankDisplay').text(resp.rank);
                    $('#totalDisplay').text(resp.totalPlayers);
                }
            });
        }

        window.closeApp = () => {
            if(liff.isInClient()) {
                liff.closeWindow();
            } else {
                location.reload();
            }
        }
    </script>
</body>
</html>