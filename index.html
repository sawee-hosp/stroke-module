<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ความรู้เรื่องสโตรก</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        /* --- CSS Variables --- */
        :root { 
            --primary-blue: #0d47a1;
            --light-blue: #e3f2fd;
            --text-dark: #1A535C;
            --bg-color: #F9FBFD;
            --font-stack: 'Kanit', sans-serif;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { 
            font-family: var(--font-stack) !important; 
            background: var(--bg-color); margin: 0; padding: 0;
            font-size: 22px; line-height: 1.6; color: #333;
            overscroll-behavior-y: contain;
        }
        button { font-family: var(--font-stack) !important; } /* บังคับ Font ปุ่ม */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; overflow-x: hidden; }
        
        h1 { 
            font-size: 42px; text-align: center; color: var(--primary-blue); 
            margin: 20px 0 30px; font-weight: 700; 
        }

        /* --- Cards --- */
        .section-card {
            background: white; border-radius: 16px; padding: 25px;
            margin-bottom: 30px; box-shadow: var(--card-shadow); border: 1px solid #e1e8ed;
        }
        .section-title {
            font-size: 28px; font-weight: 600; color: var(--primary-blue);
            margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }
        .section-desc {
            font-size: 22px; color: #555; margin-bottom: 20px; line-height: 1.6;
        }

        /* --- Buttons --- */
        .big-btn {
            width: 100%; padding: 18px; border-radius: 50px;
            font-size: 26px; font-weight: 600; text-align: center;
            cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; color: white; font-family: var(--font-stack);
        }
        .big-btn:active { transform: scale(0.98); }
        .btn-blue { background-color: var(--primary-blue); }
        .btn-orange { background-color: #ff6b6b; }

        /* --- Score & History --- */
        .score-container {
            background-color: #f1f8ff; border-radius: 12px; padding: 20px;
            margin-top: 20px; border: 1px dashed #b3e5fc;
        }
        .score-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #e1f5fe; font-size: 20px;
        }
        .score-row:last-child { border-bottom: none; }
        .badge { padding: 5px 10px; border-radius: 6px; color: white; font-size: 18px; font-weight: bold; }
        .badge-pre { background-color: #ff9800; }
        .badge-post { background-color: #4caf50; }

        /* --- Carousel (Lessons) --- */
        #lesson-section { display: none; margin-top: 30px; }
        .carousel-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding-bottom: 20px; }
        .lesson-slide {
            flex: 0 0 90%; scroll-snap-align: center; background: #fff;
            border-radius: 20px; padding: 25px; border: 1px solid #eee;
            box-shadow: var(--card-shadow); box-sizing: border-box;
        }
        .lesson-title { font-size: 32px; font-weight: 600; color: var(--text-dark); margin-bottom: 15px; text-align: center; }
        /* ปรับรูปเป็น 1:1 */
        .lesson-image { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; margin-bottom: 20px; }
        
        /* --- Quiz UI (Both Lesson & Main) --- */
        .quiz-choice {
            display: block; padding: 15px; margin: 10px 0;
            border: 2px solid #eee; border-radius: 12px;
            cursor: pointer; transition: 0.2s; font-size: 22px;
        }
        .quiz-q-text { font-size: 24px; font-weight: 600; color: var(--text-dark); margin-bottom: 15px; }
        .quiz-choice.selected { border-color: var(--primary-blue); background: var(--light-blue); }
        .quiz-choice.correct { border-color: #2ecc71 !important; background: #d5f5e3 !important; }
        .quiz-choice.wrong { border-color: #e74c3c !important; background: #fadbd8 !important; }

        /* --- In-Page Main Exam --- */
        #main-exam-section { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 2000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .timer-display { font-size: 24px; font-weight: bold; color: #e65100; }

        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        #imageModal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; flex-direction: column; }
        #modalImage { max-width: 95%; max-height: 70vh; border-radius: 10px; margin-bottom: 20px; }
        .modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 50px; cursor: pointer; }
        .btn-share { background: #06c755; color: white; padding: 15px 30px; border-radius: 30px; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; gap: 10px; align-items: center; }

    </style>
</head>
<body>

    <div class="container">
        <h1>ความรู้เรื่องสโตรก</h1>

        <!-- 1. ส่วนบทเรียน (สีน้ำเงิน) -->
        <div class="section-card" style="border-left: 8px solid var(--primary-blue);">
            <div class="section-title"><i class="bi bi-book-half"></i> บทเรียนสโตรก</div>
            <div class="section-desc">
                อ่านความรู้เรื่องสโตรก 10 บท แล้วทำข้อสอบย่อย 3 ข้อเพื่อรับคะแนนเพิ่ม<br>
                <small style="color:#d32f2f; font-size: 18px;">*อย่าลืมเลื่อนไปทางขวาเพื่ออ่านให้ครบ 10 บท</small>
            </div>
            
            <div id="btnLoadLesson" class="big-btn btn-blue" onclick="loadLessons()">
                อ่านเนื้อหา
            </div>

            <div id="lesson-section">
                <div class="loader" id="lessonLoader"></div>
                <div class="carousel-container" id="carouselContainer"></div>
                <button class="big-btn" style="background:#eee; color:#555; margin-top:20px; font-size:22px;" onclick="closeLessonSection()">ปิดบทเรียน</button>
            </div>
        </div>

        <!-- 2. ส่วนแบบทดสอบ (สีส้ม) -->
        <div class="section-card" style="border-left: 8px solid #ff6b6b;">
            <div class="section-title" style="color:#e65100;"><i class="bi bi-pencil-square"></i> แบบทดสอบวัดผล (10 คะแนน)</div>
            
            <div class="big-btn btn-orange" onclick="startMainExam()">
                ทำแบบทดสอบ
            </div>

            <!-- แสดงคะแนน -->
            <div id="scoreLoader" style="display:none; text-align:center; margin-top:15px; font-size:20px;">กำลังโหลดคะแนน...</div>
            <div id="mainScoreContainer" class="score-container" style="display:none;"></div>
        </div>

    </div>

    <!-- ส่วนทำแบบทดสอบหลัก (Popup เต็มจอ) -->
    <div id="main-exam-section">
        <div class="exam-header">
            <div style="font-size:24px; font-weight:bold;">แบบทดสอบ</div>
            <div class="timer-display" id="examTimer">0 วินาที</div>
        </div>
        <div id="exam-questions-container"></div>
        <button class="big-btn btn-orange" style="margin-top:30px;" onclick="submitMainExam()">ส่งคำตอบ</button>
        <button class="big-btn" style="background:#eee; color:#555; margin-top:15px;" onclick="closeMainExam()">ยกเลิก</button>
    </div>

    <!-- Image Modal & Share -->
    <div id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <img id="modalImage">
        <div class="btn-share" onclick="shareCurrentImage()"><i class="bi bi-share-fill"></i> แชร์ภาพนี้</div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec'; 
        const LIFF_ID = '2005789397-ROQvjpYk';

        let userProfile = null;
        let examStartTime = 0;
        let examTimerInterval;
        let currentShareImage = '';

        $(document).ready(() => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    userProfile = await liff.getProfile();
                    loadMainQuizInfo(userProfile.userId); 
                }
            } catch (e) { console.error(e); }
        }

        // --- 1. Lessons ---
        function loadLessons() {
            $('#btnLoadLesson').hide();
            $('#lesson-section').fadeIn();
            $('#lessonLoader').show();
            $('#carouselContainer').empty(); 

            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getLessons' },
                success: function(data) {
                    if(!data || data.length === 0) { 
                        alert('ไม่พบข้อมูลบทเรียน (ตรวจสอบ Sheet: learning_modules)'); 
                        closeLessonSection(); return; 
                    }
                    renderLessons(data);
                    $('#lessonLoader').hide();
                },
                error: function() {
                    alert('เชื่อมต่อฐานข้อมูลล้มเหลว');
                    closeLessonSection();
                }
            });
        }

        function renderLessons(lessons) {
            let html = '';
            lessons.forEach((lesson, index) => {
                const lessonLevel = `lesson${index + 1}`;
                html += `
                <div class="lesson-slide">
                    <h3 class="lesson-title">${lesson.title}</h3>
                    <img class="lesson-image" src="${lesson.images}" onclick="openModal('${lesson.images}')">
                    <div style="font-size:22px; color:#444; margin-bottom:20px; max-height:300px; overflow-y:auto; line-height:1.6;">
                        ${lesson.content_html || '-'}
                    </div>
                    <button class="big-btn btn-blue" style="font-size:20px; padding:12px;" onclick="loadLessonQuiz(this, '${lessonLevel}')">
                        <i class="bi bi-question-circle"></i> ทำข้อสอบบทนี้ (3 ข้อ)
                    </button>
                    <div class="lesson-quiz-container" style="display:none; margin-top:20px; border-top:2px dashed #ccc; padding-top:20px;"></div>
                </div>`;
            });
            $('#carouselContainer').html(html);
        }

        function closeLessonSection() {
            $('#lesson-section').hide();
            $('#btnLoadLesson').show();
        }

        // --- 2. Lesson Quiz (3 ข้อ) ---
        function loadLessonQuiz(btn, level) {
            const container = $(btn).next('.lesson-quiz-container');
            $(btn).hide(); container.show().html('<div class="loader"></div>');

            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getQuiz', level: level },
                success: function(questions) {
                    renderInlineQuiz(container, questions, level, 'lesson');
                }
            });
        }

        function renderInlineQuiz(container, questions, level, type) {
            if (!questions || !questions.length) { 
                container.html('<div style="text-align:center; color:red;">ไม่พบข้อสอบ (โปรดตรวจสอบข้อมูลใน Google Sheet)</div>'); 
                return; 
            }
            let html = '';
            questions.forEach((q, i) => {
                const choices = [
                    { t: q.choice1, v: q.choice1 }, { t: q.choice2, v: q.choice2 },
                    { t: q.choice3, v: q.choice3 }, { t: q.choice4, v: q.choice4 }
                ].filter(c => c.t).sort(() => Math.random() - 0.5);

                html += `<div class="quiz-item" data-correct="${q.correct_choice}" style="margin-bottom:25px;">
                    <div class="quiz-q-text">${i+1}. ${q.question}</div>`;
                choices.forEach(c => {
                    html += `<label class="quiz-choice">
                        <input type="radio" name="q_${level}_${i}" value="${c.v}" style="display:none;"> ${c.t}
                    </label>`;
                });
                html += `</div>`;
            });
            
            if (type === 'lesson') {
                html += `<button class="big-btn btn-orange" style="font-size:22px; padding:15px;" onclick="submitInlineQuiz(this, '${level}', ${questions.length})">ส่งคำตอบ</button>`;
            }
            container.html(html);
            bindChoiceEvents(container);
        }

        function bindChoiceEvents(container) {
            container.find('.quiz-choice').click(function() {
                $(this).siblings().removeClass('selected').find('input').prop('checked', false);
                $(this).addClass('selected').find('input').prop('checked', true);
            });
        }

        function submitInlineQuiz(btn, level, total) {
            const container = $(btn).parent();
            let score = 0;
            let answered = 0;
            
            container.find('.quiz-item').each(function() {
                const correct = $(this).data('correct');
                const selected = $(this).find('input:checked').val();
                const choiceEl = $(this).find('input:checked').parent();
                
                if (selected) {
                    answered++;
                    if(selected == correct) {
                        score++;
                        choiceEl.addClass('correct');
                    } else {
                        choiceEl.addClass('wrong');
                    }
                }
                $(this).find('.quiz-choice').css('pointer-events', 'none'); 
            });

            if(answered < total) { alert('กรุณาตอบให้ครบ'); return; }

            $(btn).replaceWith(`<div style="text-align:center; font-weight:bold; font-size:26px; color:#0d47a1; margin-top:20px;">คะแนน: ${score}/${total}</div>`);
            
            // Record
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: {
                    action: 'recordResult', userId: userProfile.userId, name: userProfile.displayName,
                    score: score, full_score: total, level: level, type: ''
                }
            });
        }

        // --- 3. Main Exam (10 items In-App) ---
        function startMainExam() {
            $('#main-exam-section').fadeIn();
            $('#exam-questions-container').html('<div class="loader"></div>');
            
            // Start Timer
            examStartTime = new Date().getTime();
            clearInterval(examTimerInterval);
            examTimerInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = Math.floor((now - examStartTime) / 1000);
                $('#examTimer').text(diff + " วินาที");
            }, 1000);

            // Fetch Data
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getExam' },
                success: function(questions) {
                    renderInlineQuiz($('#exam-questions-container'), questions, 'asm', 'exam'); // Use shared render
                }
            });
        }

        function submitMainExam() {
            const container = $('#exam-questions-container');
            const total = container.find('.quiz-item').length;
            if(total === 0) return;

            let score = 0;
            let answered = 0;
            
            container.find('.quiz-item').each(function() {
                const correct = $(this).data('correct');
                const selected = $(this).find('input:checked').val();
                if(selected) {
                    answered++;
                    if(selected == correct) score++;
                }
            });

            if(answered < total) { alert('กรุณาตอบให้ครบทุกข้อ'); return; }

            // Stop Timer
            clearInterval(examTimerInterval);
            const endTime = new Date().getTime();
            const timeTaken = Math.floor((endTime - examStartTime) / 1000);

            $('#main-exam-section').html(`
                <div style="text-align:center; margin-top:50px;">
                    <i class="bi bi-check-circle-fill" style="font-size:80px; color:#28a745;"></i>
                    <h1>บันทึกผลสำเร็จ</h1>
                    <div style="font-size:30px; font-weight:bold; margin:20px;">
                        คุณได้ ${score} / ${total} คะแนน
                    </div>
                    <div style="font-size:24px; color:#666;">
                        ใช้เวลา ${timeTaken} วินาที
                    </div>
                    <button class="big-btn btn-blue" onclick="location.reload()" style="margin-top:40px;">กลับหน้าหลัก</button>
                </div>
            `);

            // Determine Pre/Post
            const isPost = $('#mainScoreContainer').find('.badge-pre').length > 0;
            const type = isPost ? 'post' : 'pre';

            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: {
                    action: 'recordResult', userId: userProfile.userId, name: userProfile.displayName,
                    score: score, full_score: total, level: 'asm', 
                    type: type, time: timeTaken
                }
            });
        }

        function closeMainExam() {
            clearInterval(examTimerInterval);
            $('#main-exam-section').fadeOut();
        }

        // --- 4. History Display ---
        function loadMainQuizInfo(userId) {
            $('#scoreLoader').show();
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'get_score', userId: userId },
                success: function(res) {
                    $('#scoreLoader').hide();
                    renderScoreBoard(res);
                }
            });
        }

        function renderScoreBoard(data) {
            if (!data || (!data.pre && !data.post)) return;

            let html = '';
            // Display Pre
            if (data.pre) {
                html += `
                <div class="score-row">
                    <div><span class="badge badge-pre">ก่อนเรียน</span> <small style="color:#666">${data.pre.date}</small></div>
                    <div style="font-weight:bold; color:#0d47a1;">${data.pre.score} คะแนน <small>(${data.pre.time})</small></div>
                </div>`;
            }
            // Display Post
            if (data.post) {
                html += `
                <div class="score-row">
                    <div><span class="badge badge-post">หลังเรียน</span> <small style="color:#666">${data.post.date}</small></div>
                    <div style="font-weight:bold; color:#0d47a1;">${data.post.score} คะแนน <small>(${data.post.time})</small></div>
                </div>`;
            }
            $('#mainScoreContainer').html(html).fadeIn();
        }

        // --- Utils: Share & Modal ---
        function openModal(src) { 
            currentShareImage = src;
            $('#modalImage').attr('src', src); 
            $('#imageModal').css('display','flex').fadeIn(); 
        }
        function closeModal() { $('#imageModal').fadeOut(); }
        
        function shareCurrentImage() {
            if (liff.isApiAvailable('shareTargetPicker')) {
                const msg = {
                    type: "flex", altText: "ความรู้เรื่องสโตรก",
                    contents: {
                        type: "bubble",
                        hero: { type: "image", url: currentShareImage, size: "full", aspectRatio: "1:1", aspectMode: "cover" },
                        body: {
                            type: "box", layout: "vertical",
                            contents: [
                                { type: "text", text: "สาระน่ารู้จาก รพ.สวี", weight: "bold", size: "lg", align: "center" }
                            ]
                        }
                    }
                };
                liff.shareTargetPicker([msg]).catch(e => console.log(e));
            } else {
                alert("อุปกรณ์นี้ไม่รองรับการแชร์");
            }
        }

    </script>
</body>
</html>