<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap"
        rel="stylesheet"/>
  <style>
    /* Reset & Base */
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:'Noto Sans Thai',sans-serif;
      background:#f0f2f5;
      display:flex; justify-content:center; align-items:flex-start;
      padding:40px 0;
    }
    .container { max-width:480px; width:100%; padding:0 16px; }

    /* Header */
    h1 { font-size:2.2rem; color:#1a237e; text-align:center; margin-bottom:4px; }
    .subtitle { font-size:0.9rem; color:#666; text-align:center; margin-bottom:4px; }
    .history  { font-size:1rem; color:#444; text-align:center; margin-bottom:24px; }

    /* Tabs */
    .tabs { display:flex; margin-bottom:24px; border-radius:8px; overflow:hidden;
            box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .tabs button {
      flex:1; padding:12px; font-size:1rem; font-weight:600;
      border:none; background:#e0e0e0; cursor:pointer; transition:background .3s;
    }
    .tabs button.active { background:#3949ab; color:#fff; }
    .tabs button:not(.active):hover { background:#d5d5d5; }

    /* Cards */
    .card {
      background:#fff; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      padding:24px; margin-bottom:24px;
      transition:transform .2s;
    }
    .card:hover { transform:translateY(-2px); }

    /* Start Card Buttons */
    .button-group { display:flex; gap:16px; }
    .btn {
      flex:1; padding:14px; font-size:1rem; font-weight:600; color:#fff;
      border:none; border-radius:8px; cursor:pointer;
      transition:background .3s,box-shadow .3s;
    }
    .btn-video {
      background:linear-gradient(45deg,#43a047,#66bb6a);
      box-shadow:0 4px 8px rgba(67,160,71,0.3);
    }
    .btn-video:hover { background:linear-gradient(45deg,#388e3c,#57a05a); }
    .btn-quiz {
      background:linear-gradient(45deg,#1e88e5,#42a5f5);
      box-shadow:0 4px 8px rgba(30,136,229,0.3);
    }
    .btn-quiz:hover { background:linear-gradient(45deg,#1565c0,#1e7ae1); }

    /* Quiz Card */
    #quiz-card, #result-card { display:none; }
    #quiz-card img {
      width:100%; border-radius:8px;
      margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    #progress {
      height:8px; background:#e0e0e0;
      border-radius:4px; overflow:hidden; margin-bottom:16px;
    }
    #progress-bar {
      height:100%; background:#1e88e5;
      width:0; transition:width .4s ease;
    }
    .question {
      font-size:1.4rem; font-weight:bold;
      color:#1a237e; margin-bottom:16px;
    }
    .choices label {
      display:block; font-size:1.1rem;
      margin-bottom:12px; padding:12px; border-radius:6px;
      background:#f7f7f7; cursor:pointer; transition:background .3s;
    }
    .choices label:hover { background:#ececec; }
    .choices input {
      margin-right:10px; transform:scale(1.2);
    }
    #submitBtn {
      display:none; width:100%; padding:12px;
      font-size:1.1rem; font-weight:600; color:#fff;
      background:#5e35b1; border:none; border-radius:8px;
      cursor:pointer; margin-top:16px; transition:background .3s;
    }
    #submitBtn:hover { background:#512da8; }

    /* Answer Modal */
    .modal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center; z-index:1000;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px;
      max-width:300px; text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content p { margin-bottom:16px; font-size:1.1rem; }
    .modal-content button {
      padding:10px 20px; font-size:1rem; font-weight:600;
      color:#fff; background:#1e88e5;
      border:none; border-radius:6px; cursor:pointer;
      transition:background .3s;
    }
    .modal-content button:hover { background:#1565c0; }

    /* Share Button */
    #shareBtn {
      display:none; width:100%; padding:12px;
      margin-top:16px; font-size:1.1rem;
      font-weight:600; color:#fff;
      background:linear-gradient(45deg,#fb8c00,#ffb74d);
      border:none; border-radius:8px; cursor:pointer;
      transition:background .3s;
    }
    #shareBtn:hover { background:linear-gradient(45deg,#f57c00,#ffa726); }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <h1>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</h1>
    <div class="subtitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
    <div id="quiz-history" class="history">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="active" data-level="general">Quiz ‡∏™‡πÇ‡∏ï‡∏£‡∏Å (10)</button>
      <button data-level="asm">Quiz ‡∏≠‡∏™‡∏°. (20)</button>
    </div>

    <!-- Start Card -->
    <div id="start-card" class="card">
      <div class="button-group">
        <button id="btnVideo" class="btn btn-video">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        <button id="btnQuiz"  class="btn btn-quiz">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
      </div>
    </div>

    <!-- Quiz Card -->
    <div id="quiz-card" class="card">
      <img id="infographic" src="" alt="Infographic"/>
      <div id="progress"><div id="progress-bar"></div></div>
      <div id="questionText" class="question"></div>
      <div id="choicesContainer" class="choices"></div>
      <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <!-- Result Card -->
    <div id="result-card" class="card">
      <h2 style="margin-top:0;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="scoreText" style="font-size:1.2rem;"></p>
      <p id="wrongText" style="font-size:1rem;color:#c62828;"></p>
      <button id="shareBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•</button>
    </div>
  </div>

  <!-- Answer Modal -->
  <div id="answerModal" class="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <button id="modalNextBtn">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec';
    const LIFF_ID = '2005789397-ROQvjpYk';
    let userProfile, level='general', questions=[], idx=0, score=0, wrongs=[];
    let chosenKey = null;

    function makeDriveUrl(u) {
      const m = u.match(/\/d\/([^\/]+)/) || u.match(/id=([^&]+)/);
      return m ? `https://drive.google.com/uc?export=view&id=${m[1]}` : u;
    }

    // JSONP callbacks
    window.handleHistory = data => {
      const el = document.getElementById('quiz-history');
      if (!data.length) {
        el.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö';
      } else {
        const last = data[data.length-1];
        el.innerHTML = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <strong>${last.score}/${last.full_score}</strong>`;
      }
      renderStartCard();
    };

    window.handleUserName = resp => {
      const last = window._lastHistory;
      const startCard = document.getElementById('start-card');
      const name = resp.name || userProfile.displayName;
      const sc   = last.score, full = last.full_score;
      let intro;
      if (sc < full) {
        intro = `<p>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${sc}/${full}</p>
                 <p>‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ${full} ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞ ‚Üì</p>`;
      } else {
        intro = `<p>‡∏Ñ‡∏∏‡∏ì ${name} ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß üéâ</p>
                 <p>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏° ‚Üì</p>`;
      }
      startCard.innerHTML = `
        <div class="card">${intro}
          <div class="button-group">
            <button id="btnVideo" class="btn btn-video">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
            <button id="btnQuiz"  class="btn btn-quiz">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
          </div>
        </div>`;
      attachStartButtons();
    };

    // Render start card depending on history
    function renderStartCard() {
      const startCard = document.getElementById('start-card');
      const historyText = document.getElementById('quiz-history').textContent;
      if (historyText === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö') {
        startCard.innerHTML = `
          <div class="card" style="text-align:center;">
            <p>‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞</p>
            <p>‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô</p>
            <p>‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡∏à‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÇ‡∏£‡∏Ñ‡∏≠‡∏±‡∏°‡∏û‡∏≤‡∏ï</p>
            <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ ‚Üì</p>
            <div class="button-group">
              <button id="btnVideo" class="btn btn-video">‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
              <button id="btnQuiz"  class="btn btn-quiz">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            </div>
          </div>`;
      } else {
        // parse last history and fetch name
        const parts = historyText.match(/(\d+)\/(\d+)/);
        window._lastHistory = { score: +parts[1], full_score: +parts[2] };
        const s = document.createElement('script');
        s.src = `${GAS_URL}?action=getUserName&userId=${userProfile.userId}&callback=handleUserName`;
        document.head.appendChild(s);
      }
      attachStartButtons();
    }

    function attachStartButtons() {
      document.getElementById('btnQuiz').onclick = () => {
        const s = document.createElement('script');
        s.src = `${GAS_URL}?action=getQuiz&level=${level}&callback=handleQuiz`;
        document.head.appendChild(s);
      };
      document.getElementById('btnVideo').onclick = () => {
        window.open('https://youtu.be/your_video_url','_blank');
        setTimeout(() => document.getElementById('btnQuiz').click(), 500);
      };
    }

    window.handleQuiz = data => {
      questions = data; idx=0; score=0; wrongs=[]; chosenKey=null;
      document.getElementById('start-card').style.display = 'none';
      document.getElementById('result-card').style.display = 'none';
      document.getElementById('quiz-card').style.display   = 'block';
      showQuestion();
    };

    function showQuestion() {
      const q = questions[idx];
      // Infographic
      const img = document.getElementById('infographic');
      if (q.infographic) {
        img.src = makeDriveUrl(q.infographic);
        img.style.display = 'block';
      } else img.style.display = 'none';

      // Progress
      document.getElementById('progress-bar').style.width = `${(idx+1)/questions.length*100}%`;

      // Text
      document.getElementById('questionText').textContent = q.question;

      // Choices
      chosenKey = null;
      const keys = shuffle(['choice1','choice2','choice3','choice4']);
      const cont = document.getElementById('choicesContainer'); cont.innerHTML = '';
      keys.forEach(key => {
        const lbl = document.createElement('label');
        lbl.textContent = q[key];
        lbl.onclick = () => {
          chosenKey = key;
          document.getElementById('submitBtn').style.display = 'block';
          document.querySelectorAll('.choices label').forEach(l => l.classList.remove('selected'));
          lbl.classList.add('selected');
        };
        cont.appendChild(lbl);
      });
      // prepend inputs
      document.querySelectorAll('.choices label').forEach(l => {
        const inp = document.createElement('input');
        inp.type='radio'; inp.name='choice'; inp.value=l.textContent;
        l.prepend(inp);
      });

      // Submit
      const sb = document.getElementById('submitBtn');
      sb.style.display = 'none';
      sb.onclick = () => checkAnswer(q);
    }

    // Answer feedback
    function checkAnswer(q) {
      const correctKey = q.correct_choice.toLowerCase();
      const correctVal = q[correctKey];
      const isCorrect  = chosenKey === correctKey;
      const modal      = document.getElementById('answerModal');
      const msg        = document.getElementById('modalMessage');

      if (isCorrect) {
        score++;
        msg.textContent = '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
      } else {
        wrongs.push(q.test_id);
        msg.textContent = `üòû ‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${correctVal}`;
      }
      modal.style.display = 'flex';
      document.getElementById('modalNextBtn').onclick = () => {
        modal.style.display = 'none';
        idx < questions.length - 1 ? showQuestionAt(idx+1) : finishQuiz();
      };
    }

    function showQuestionAt(i) {
      idx = i;
      document.getElementById('submitBtn').style.display = 'none';
      showQuestion();
    }

    // Final summary + share
    function finishQuiz() {
      document.getElementById('quiz-card').style.display   = 'none';
      const rc = document.getElementById('result-card');
      document.getElementById('scoreText').textContent     = `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${score}/${questions.length} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
      document.getElementById('wrongText').textContent     = wrongs.length
        ? `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î: ${wrongs.join(',')}`
        : '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!';
      rc.style.display = 'block';
      document.getElementById('shareBtn').style.display = 'block';
    }

    document.getElementById('shareBtn')?.addEventListener('click', () => {
      // JSONP recordResult -> returns rank + totalPlayers
      const params = [
        'action=recordResult',
        `userId=${userProfile.userId}`,
        `level=${level}`,
        `score=${score}`,
        `full_score=${questions.length}`,
        `posttest=true`,
        `wrong=${encodeURIComponent(wrongs.join(','))}`,
        'callback=handleShareRecord'
      ];
      const s = document.createElement('script');
      s.src = `${GAS_URL}?${params.join('&')}`;
      document.head.appendChild(s);
    });

    window.handleShareRecord = resp => {
      if (resp.status !== 'success') return console.error(resp);
      const rank         = resp.rank;
      const totalPlayers = resp.totalPlayers;
      const name         = userProfile.displayName || '‡∏Ñ‡∏∏‡∏ì‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
      const pictureUrl   = userProfile.pictureUrl;
      // Build the Flex message
      const flex = {
        type: 'flex',
        altText: `${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
        contents: {
          type: 'bubble',
          size: 'kilo',
          header: {
            type: 'box', layout: 'vertical', contents: [
              { type: 'text', text: `üëë ${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
                align:'center', weight:'bold', size:'lg' }
            ]
          },
          hero: {
            type: 'image',
            url: pictureUrl,
            size: 'full',
            aspectMode: 'cover',
            aspectRatio:'1:1',
            gravity:'center'
          },
          body: {
            type: 'box', layout: 'vertical', contents:[
              { type:'text', text:'‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', align:'center', size:'md' },
              { type:'text', text:`${score}/${questions.length}`, align:'center', size:'xxl', weight:'bold' },
              { type:'text', text:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô', align:'center', size:'sm', color:'#555555' },
              { type:'text', text:`‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${rank} ‡∏à‡∏≤‡∏Å ${totalPlayers} ‡∏Ñ‡∏ô`, align:'center', size:'sm', color:'#555555' }
            ]
          },
          footer: {
            type: 'box', layout: 'vertical', spacing: 'sm', contents:[
              {
                type:'button', style:'primary',
                action:{ type:'uri', label:'‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö', uri:`https://liff.line.me/${LIFF_ID}` }
              },
              {
                type:'button', style:'secondary',
                action:{ type:'uri', label:'‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£', uri:'https://lin.ee/mQhHzLv' }
              }
            ]
          }
        }
      };
      liff.shareTargetPicker([flex])
        .then(()=> console.log('Shared!'))
        .catch(err=> console.error(err));
    };

    // Utility: shuffle
    function shuffle(a) {
      for (let i=a.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // LIFF init & loadHistory
    document.addEventListener('DOMContentLoaded', async () => {
      await liff.init({ liffId:LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();
      userProfile = await liff.getProfile();
      loadHistory();
    });

    function loadHistory() {
      if (!userProfile?.userId) return;
      const s = document.createElement('script');
      s.src = `${GAS_URL}?action=getHistory&userId=${userProfile.userId}&level=${level}&callback=handleHistory`;
      document.head.appendChild(s);
    }
  </script>
</body>
</html>
