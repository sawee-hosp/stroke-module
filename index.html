<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap"
        rel="stylesheet"/>
  <style>
    /* Reset & Base */
    *,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:'Noto Sans Thai',sans-serif!important;
      font-size:18px;
      background:#f0f2f5;
      display:flex;
      justify-content:center;
      padding:40px 0;
    }
    .container {
      width:100%; max-width:480px; padding:0 16px;
    }

    /* Ensure all interactive elements inherit Noto */
    button,input,label,a { font-family:'Noto Sans Thai',sans-serif!important; }

    /* Card */
    .card {
      background:#fff;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      padding:20px;
      margin-bottom:20px;
      text-align:center;
    }
    h1 {
      font-size:28px;
      color:#1a237e;
      margin-bottom:16px;
    }

    /* Start */
    .intro {
      line-height:1.6;
      color:#333;
      margin-bottom:16px;
    }
    .button-group {
      display:flex; gap:12px;
    }
    .btn {
      flex:1;
      padding:12px;
      font-size:18px;
      font-weight:700;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      background:linear-gradient(45deg,#1e88e5,#42a5f5);
      transition:background .2s;
    }
    .btn:hover {
      background:linear-gradient(45deg,#1565c0,#1e7ae1);
    }

    /* Quiz */
    #quiz-card { display:none; }
    #progress {
      position:relative; height:8px;
      background:#e0e0e0; border-radius:4px;
      margin-bottom:16px;
    }
    #progress-bar {
      height:100%; width:0;
      background:#1e88e5; transition:width .3s;
    }
    #qindex {
      position:absolute; top:-24px;
      left:50%; transform:translateX(-50%);
      font-size:16px; font-weight:700; color:#333;
    }
    .question {
      font-size:20px; font-weight:700;
      color:#1a237e; margin-bottom:16px;
    }
    .choices label {
      display:block;
      font-size:18px;
      margin-bottom:12px;
      padding:12px;
      background:#f7f7f7;
      border-radius:6px;
      cursor:pointer;
      text-align:left;
      transition:background .2s;
    }
    .choices label:hover { background:#ececec; }
    .choices input {
      margin-right:12px;
      transform:scale(1.2);
    }
    #submitBtn {
      display:none; width:100%;
      padding:12px; margin-top:16px;
      background:#5e35b1; color:#fff;
      border:none; border-radius:6px;
      font-size:18px; font-weight:700;
      cursor:pointer;
      transition:background .2s;
    }
    #submitBtn:hover { background:#512da8; }

    /* Modal */
    .modal {
      display:none; position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4);
      justify-content:center; align-items:center;
      z-index:1000;
    }
    .modal-content {
      background:#fff; padding:24px;
      border-radius:6px; text-align:center;
      width:90%; max-width:360px;
    }
    .modal-content p {
      font-size:22px; margin-bottom:16px;
    }
    .modal-content button {
      padding:10px 24px;
      font-size:18px; font-weight:700;
      color:#fff; background:#1e88e5;
      border:none; border-radius:6px;
      cursor:pointer; transition:background .2s;
    }
    .modal-content button:hover { background:#1565c0; }

    /* Result */
    #result-card { display:none; }
    #result-card h2 {
      font-size:22px; margin-bottom:16px;
    }
    #result-card p {
      font-size:18px; margin-bottom:12px;
    }
    #btnLearn {
      display:inline-block;
      padding:8px 16px;
      font-size:16px;
      color:#1e88e5;
      background:none;
      border:1px solid #1e88e5;
      border-radius:4px;
      text-decoration:none;
      margin-bottom:16px;
    }
    #shareBtn {
      display:none; width:100%;
      padding:12px; margin-top:16px;
      background:linear-gradient(45deg,#fb8c00,#ffb74d);
      color:#fff; border:none; border-radius:6px;
      font-size:18px; font-weight:700;
      cursor:pointer; transition:background .2s;
    }
    #shareBtn:hover { background:linear-gradient(45deg,#f57c00,#ffa726); }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</h1>

    <!-- Start Card -->
    <div id="start-card" class="card">
      <div class="intro">
        ‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô<br/>
        ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?
      </div>
      <div class="button-group">
        <button id="btnQuiz" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
      </div>
    </div>

    <!-- Quiz Card -->
    <div id="quiz-card" class="card">
      <div id="progress">
        <span id="qindex">1/10</span>
        <div id="progress-bar"></div>
      </div>
      <div id="questionText" class="question"></div>
      <div id="choicesContainer" class="choices"></div>
      <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>

    <!-- Result Card -->
    <div id="result-card" class="card">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
      <p id="resultMessage"></p>
      <a id="btnLearn" href="https://lin.ee/mQhHzLv" target="_blank">‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£</a><br/>
      <button id="shareBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
    </div>
  </div>

  <!-- Answer Modal -->
  <div id="answerModal" class="modal">
    <div class="modal-content">
      <p id="modalMessage"></p>
      <button id="modalNextBtn">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/.../exec';
    const LIFF_ID = '2005789397-ROQvjpYk';
    let userProfile, questions = [], idx = 0, score = 0, wrongs = [], cachedRank, cachedTotal;

    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // 1) Start button
    document.getElementById('btnQuiz').onclick = () => {
      const s = document.createElement('script');
      s.src = `${GAS_URL}?action=getQuiz&level=general&callback=handleQuiz`;
      document.head.appendChild(s);
    };

    // 2) Load quiz
    window.handleQuiz = data => {
      questions = data;
      idx = 0; score = 0; wrongs = [];
      document.getElementById('start-card').style.display = 'none';
      document.getElementById('quiz-card').style.display  = 'block';
      showQuestion();
    };

    function showQuestion(){
      const q = questions[idx];
      document.getElementById('qindex').textContent = `${idx+1}/${questions.length}`;
      document.getElementById('progress-bar').style.width = `${(idx+1)/questions.length*100}%`;
      document.getElementById('questionText').textContent = q.question;
      const cont = document.getElementById('choicesContainer');
      cont.innerHTML = '';
      shuffle(['choice1','choice2','choice3','choice4']).forEach(key=>{
        const lbl = document.createElement('label');
        lbl.textContent = q[key];
        lbl.onclick = () => {
          document.getElementById('submitBtn').style.display='block';
          document.querySelectorAll('.choices label').forEach(l=>l.classList.remove('selected'));
          lbl.classList.add('selected');
        };
        cont.appendChild(lbl);
      });
      cont.querySelectorAll('label').forEach(lbl=>{
        const inp=document.createElement('input');
        inp.type='radio'; inp.name='choice'; inp.value=lbl.textContent;
        lbl.prepend(inp);
      });
      const sb=document.getElementById('submitBtn');
      sb.style.display='none';
      sb.onclick = () => checkAnswer(q);
    }

    function checkAnswer(q){
      const sel = document.querySelector('input[name="choice"]:checked');
      if(!sel) return;
      const chosen = sel.value.trim();
      const correct= q.correct_choice.trim();  // strict ===
      const modal=document.getElementById('answerModal');
      const msg=document.getElementById('modalMessage');
      msg.textContent = (chosen===correct)
        ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'
        : `üòû ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${correct}`;
      if(chosen!==correct) wrongs.push(q.test_id);
      modal.style.display='flex';
      document.getElementById('modalNextBtn').onclick = ()=>{
        modal.style.display='none';
        idx<questions.length-1
          ? showQuestionAt(idx+1)
          : finishQuiz();
      };
    }

    function showQuestionAt(i){
      idx=i;
      document.getElementById('submitBtn').style.display='none';
      showQuestion();
    }

    // 3) Finish
    function finishQuiz(){
      document.getElementById('quiz-card').style.display='none';
      document.getElementById('result-card').style.display='block';
      let msgTxt;
      if(score<=4) msgTxt='‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö‚Ä¶ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà';
      else if(score<=8) msgTxt='‡πÄ‡∏Å‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‚Ä¶ ‡∏°‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Å‡∏±‡∏ô';
      else msgTxt='‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢';
      document.getElementById('resultMessage').innerHTML =
        `<strong>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${score}/${questions.length} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong><br/>${msgTxt}`;

      // Auto‚Äêrecord
      const params=[
        'action=recordResult',
        `userId=${userProfile.userId}`,
        'level=general',
        `score=${score}`,
        `full_score=${questions.length}`,
        'posttest=true',
        `wrong=${encodeURIComponent(wrongs.join(','))}`,
        'callback=cacheRank'
      ];
      const s=document.createElement('script');
      s.src=`${GAS_URL}?${params.join('&')}`;
      document.head.appendChild(s);
    }

    window.cacheRank = resp => {
      if(resp.status==='success'){
        cachedRank=resp.rank;
        cachedTotal=resp.totalPlayers;
        document.getElementById('shareBtn').style.display='block';
      }
    };

    // 4) Share flex
    document.getElementById('shareBtn').onclick = () => {
      const name=userProfile.displayName;
      const pic=userProfile.pictureUrl;
      const flex={
        type:'flex',altText:`${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
        contents:{
          type:'bubble',size:'kilo',
          header:{
            type:'box',layout:'vertical',backgroundColor:'#FFF9C4',
            contents:[
              {type:'text',text:`${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,align:'center',weight:'bold',size:'lg'},
              {type:'text',text:'üëë',align:'center',size:'4xl'}
            ]
          },
          body:{
            type:'box',layout:'vertical',backgroundColor:'#FFF9C4',spacing:'none',paddingAll:'0px',
            contents:[
              {type:'image',url:pic,size:'full',aspectMode:'cover',cornerRadius:'999px'},
              {type:'text',text:`‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å ${score}/${questions.length}`,align:'center',size:'md',weight:'bold'},
              {type:'text',text:`‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${cachedRank} ‡∏à‡∏≤‡∏Å ${cachedTotal}`,align:'center',size:'sm',color:'#666666'}
            ]
          },
          footer:{
            type:'box',layout:'vertical',backgroundColor:'#FFF9C4',spacing:'none',paddingAll:'0px',
            contents:[
              {type:'button',style:'primary',action:{type:'uri',label:'‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å',uri:`https://liff.line.me/${LIFF_ID}`}},
              {type:'text',text:'‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å',align:'center',size:'sm',color:'#1e88e5',action:{type:'uri',uri:'https://lin.ee/mQhHzLv'}}
            ]
          }
        }
      };
      console.log('Flex payload:',JSON.stringify(flex));
      liff.shareTargetPicker([flex])
        .then(()=>alert('‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'))
        .catch(e=>console.error(e));
    };

    // LIFF init
    document.addEventListener('DOMContentLoaded',async()=>{
      await liff.init({liffId:LIFF_ID});
      if(!liff.isLoggedIn()) liff.login();
      userProfile=await liff.getProfile();
    });
  </script>
</body>
</html>
