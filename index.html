<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet"/>
<style>
  :root { --primary-color: #1a237e; --secondary-color: #1e88e5; --light-yellow: #fffde7; }
  html { scroll-behavior: smooth; }
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
  body,button,label,input{font-family:'Noto Sans Thai',sans-serif!important}
  body{background:#f0f2f5;display:flex;justify-content:center;padding:40px 0}
  .container{width:100%;max-width:480px;padding:0 16px}
  h1{text-align:center;font-size:28px;color:var(--primary-color);margin-bottom:16px}

  /* History Card */
  #history-card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);
    padding:20px;text-align:center;margin-bottom:24px;min-height:120px;display:flex;
    align-items:center;justify-content:center;font-size:18px;color:#333; line-height: 1.6;}

  /* Grid of 4 cards */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
  .card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);
    padding:20px;text-align:center;cursor:pointer;min-height:140px;display:flex;
    flex-direction:column;justify-content:center;transition:transform .2s; border: 2px solid transparent;}
  .card:hover{transform:translateY(-4px)}
  .card.active{border:2px solid var(--secondary-color); background:#e8f0fe}
  .emoji{font-size:36px;margin-bottom:8px}
  .title{font-size:18px;font-weight:700;color:#333}

  /* Quiz Card */
  #quiz-card{min-height:500px;padding-top:20px}
  #quiz-card,#result-card {display:none}
  #progress{position:relative;height:8px;background:#e0e0e0;border-radius:4px;margin:0 0 16px}
  #progress-bar{height:100%;width:0;background:var(--secondary-color);transition:width .3s}
  #qindex{position:absolute;top:-4px;left:50%;transform:translateX(-50%);font-size:14px;font-weight:700;color:#333}
  .question{font-size:24px;font-weight:700;color:var(--primary-color);margin:24px 0}
  .choices label{display:block;font-size:18px;padding:12px;background:#f7f7f7;
    border-radius:6px;margin-bottom:12px;cursor:pointer;transition:background .2s;text-align:left}
  .choices label:hover{background:#ececec}
  .choices label.selected{background:#d1eaff;border:1px solid var(--secondary-color);}
  .choices input{margin-right:12px;transform:scale(1.2)}
  #submitBtn{display:none;width:100%;padding:12px;margin-top:16px;
    background:#5e35b1;color:#fff;border:none;border-radius:6px;font-size:18px;font-weight:700;
    cursor:pointer;transition:background .2s}
  #submitBtn:hover{background:#512da8}
  .link-note{font-size:16px; color:var(--secondary-color); font-weight: bold; margin-top:20px; text-align:center;}
  .link-note span{cursor:pointer;text-decoration:underline;}

  /* Result Card */
  #result-card{padding-top:20px;text-align:center}
  .result-emoji{font-size:64px;margin-bottom:16px}
  .result-message{font-size:22px;line-height:1.6}
  #shareBtn{display:none;width:100%;padding:12px;margin-top:24px;
    background:linear-gradient(45deg,#fb8c00,#ffb74d);color:#fff;border:none;border-radius:6px;
    font-size:18px;font-weight:700;cursor:pointer}

  /* Modal */
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.5);display:none;justify-content:center;
    align-items:center;z-index:1000}
  .modal.show {display: flex;}
  .modal-content{background:#fff;padding:24px;border-radius:8px;
    max-width: calc(100% - 32px); width:400px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.15);}
  .modal-emoji{font-size:64px;margin-bottom:16px}
  .modal-text{font-size:24px;margin-bottom:24px}
  .modal-content button{width:100%; padding:10px 24px;font-size:18px;font-weight:700;
    color:#fff;background:var(--secondary-color);border:none;border-radius:6px;cursor:pointer;transition:.2s}
  .modal-content button.close-btn {background-color: #f44336; margin-top: 10px;}

  /* Accordion */
  .accordion{margin:16px 0}
  .accordion-item:not(:last-child){border-bottom:1px solid #ddd}
  .accordion-header{padding:12px;font-size:18px;font-weight:700;cursor:pointer;
    background:#e3f2fd;display:flex;justify-content:space-between;align-items:center}
  .accordion-header.active{background:#bbdefb}
  .accordion-header .icon{font-size:20px; transition: transform 0.2s;}
  .accordion-header.active .icon{transform: rotate(45deg);}
  .accordion-body{padding:12px;font-size:16px;line-height:1.6;display:none; border-top: 1px solid #ddd;}
</style>
</head>
<body>
<div class="container">
  <h1>‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</h1>

  <div id="history-card">
    <div id="history-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div class="grid">
    <div id="cardGeneralQuiz" class="card"><div class="emoji">‚ùì</div><div class="title">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å</div></div>
    <div id="cardGeneralLearn" class="card"><div class="emoji">üìñ</div><div class="title">‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</div></div>
    <div id="cardAsmQuiz" class="card"><div class="emoji">ü©∫</div><div class="title">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡∏≠‡∏™‡∏°.</div></div>
    <div id="cardAsmGuide" class="card"><div class="emoji">üìã</div><div class="title">‡πÅ‡∏ô‡∏ß‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏≠‡∏™‡∏°.</div></div>
  </div>

  <div id="quiz-card" class="card">
    <div id="progress"><span id="qindex">1/10</span><div id="progress-bar"></div></div>
    <div id="questionText" class="question"></div>
    <div id="choicesContainer" class="choices"></div>
    <button id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    <div class="link-note">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö <span id="openLearn">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</span></div>
  </div>

  <div id="result-card" class="card">
    <div id="resultEmoji" class="result-emoji"></div>
    <div id="resultMessage" class="result-message"></div>
    <button id="shareBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
  </div>
</div>

<div id="answerModal" class="modal"><div class="modal-content"><div id="modalEmoji" class="modal-emoji"></div><div id="modalMessage" class="modal-text"></div><button id="modalNextBtn">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button></div></div>
<div id="learn-card" class="modal"><div class="modal-content" style="max-height:80vh;overflow:auto;text-align:left"><h2>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2><div class="accordion"><div class="accordion-item"><div class="accordion-header">1. ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‚Äú‡∏™‡πÇ‡∏ï‡∏£‡∏Å‚Äù<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á ‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡∏µ‡∏ö/‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏Å ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏™‡∏°‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏±‡∏°‡∏û‡∏§‡∏Å‡∏©‡πå ‡∏≠‡∏±‡∏°‡∏û‡∏≤‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ</p></div></div><div class="accordion-item"><div class="accordion-header">2. ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<span class="icon">Ôºã</span></div><div class="accordion-body"><p><strong>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ:</strong> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô, ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á, ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà, ‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô, ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</p></div></div><div class="accordion-item"><div class="accordion-header">3. ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô BEFAST<span class="icon">Ôºã</span></div><div class="accordion-body"><ul style="padding-left:1em"><li><strong>B</strong> (Balance): ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã</li><li><strong>E</strong> (Eyes): ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô</li><li><strong>F</strong> (Face): ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß</li><li><strong>A</strong> (Arm): ‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á</li><li><strong>S</strong> (Speech): ‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î</li><li><strong>T</strong> (Time): ‡∏£‡∏µ‡∏ö‡πÇ‡∏ó‡∏£ 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li></ul></div></div></div><button class="close-btn">‡∏õ‡∏¥‡∏î</button></div></div>
<div id="asm-guide" class="modal"><div class="modal-content" style="max-height:80vh;overflow:auto;text-align:left"><h2>‡πÅ‡∏ô‡∏ß‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏≠‡∏™‡∏°.‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2><div class="accordion"><div class="accordion-item"><div class="accordion-header">1. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡∏≠‡∏™‡∏°. ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</p></div></div><div class="accordion-item"><div class="accordion-header">2. ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô BEFAST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</p></div></div><div class="accordion-item"><div class="accordion-header">3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢<span class="icon">Ôºã</span></div><div class="accordion-body"><p>‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å BEFAST ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ö‡πÇ‡∏ó‡∏£‡πÅ‡∏à‡πâ‡∏á 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏à‡∏±‡∏î‡∏ó‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡∏≠‡∏ô‡∏£‡∏≤‡∏ö ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p></div></div></div><button class="close-btn">‡∏õ‡∏¥‡∏î</button></div></div>


<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec';
const LIFF_ID='2005789397-ROQvjpYk';
let userProfile, currentQuizLevel = '', idx = 0, score = 0, wrongs = [];
let cachedRank, cachedTotal, _name = '';

const shuffle = a => {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

// --- History & User Info ---
function loadUserHistory() {
  if (!userProfile?.userId) return;
  const script = document.createElement('script');
  script.src = `${GAS_URL}?action=getUserHistory&userId=${encodeURIComponent(userProfile.userId)}&callback=handleUserHistory`;
  document.head.appendChild(script);
}

window.handleUserHistory = (data) => {
  const txt = document.getElementById('history-text');
  _name = data.name || userProfile.displayName;
  let msg = '';
  if (data.lastScore === null) {
    msg = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <strong>${_name}</strong>!<br>‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å' ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‡∏ñ‡πâ‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö`;
  } else {
    if (data.lastLevel === 'asm') {
      msg = `‡∏Ñ‡∏∏‡∏ì <strong>${_name}</strong><br>‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‡∏≠‡∏™‡∏°.‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡πÑ‡∏î‡πâ <strong>${data.lastScore}</strong> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠ ‡∏Ñ‡∏•‡∏¥‡∏Å '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ ‡∏≠‡∏™‡∏°.' ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`;
    } else {
      msg = `‡∏Ñ‡∏∏‡∏ì <strong>${_name}</strong><br>‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡πÑ‡∏î‡πâ <strong>${data.lastScore}</strong> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡∏°‡∏∑‡∏≠ ‡∏Ñ‡∏•‡∏¥‡∏Å '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å' ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`;
    }
  }
  txt.innerHTML = msg;
};

// --- Quiz Logic ---
function loadQuiz(level) {
  currentQuizLevel = level;
  const script = document.createElement('script');
  script.src = `${GAS_URL}?action=getQuiz&level=${level}&callback=handleQuiz`;
  document.head.appendChild(script);
}

window.handleQuiz = (data) => {
  if (!data || data.length === 0) {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    return;
  }
  questions = data;
  idx = 0; score = 0; wrongs = [];
  const quizCard = document.getElementById('quiz-card');
  quizCard.style.display = 'block';
  quizCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  showQuestion();
};

function showQuestion() {
  const q = questions[idx];
  document.getElementById('qindex').textContent = `${idx + 1}/${questions.length}`;
  document.getElementById('progress-bar').style.width = `${(idx + 1) / questions.length * 100}%`;
  document.getElementById('questionText').textContent = q.question;
  const choicesContainer = document.getElementById('choicesContainer');
  choicesContainer.innerHTML = '';
  const choices = shuffle(['choice1', 'choice2', 'choice3', 'choice4']);

  choices.forEach(key => {
    if (q[key]) {
      const label = document.createElement('label');
      label.innerHTML = `<input type="radio" name="choice" value="${q[key].trim()}"> ${q[key]}`;
      label.onclick = () => {
        document.querySelectorAll('.choices label').forEach(l => l.classList.remove('selected'));
        label.classList.add('selected');
        document.getElementById('submitBtn').style.display = 'block';
      };
      choicesContainer.appendChild(label);
    }
  });

  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('submitBtn').onclick = () => checkAnswer(q);
}

function checkAnswer(question) {
  const selected = document.querySelector('input[name="choice"]:checked');
  if (!selected) return;

  const isCorrect = selected.value === question.correct_choice.trim();
  if (isCorrect) {
    score++;
    document.getElementById('modalEmoji').textContent = '‚úÖ';
    document.getElementById('modalMessage').textContent = '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
  } else {
    wrongs.push(question.test_id);
    document.getElementById('modalEmoji').textContent = 'üòû';
    document.getElementById('modalMessage').textContent = `‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠:\n${question.correct_choice}`;
  }
  
  document.getElementById('answerModal').classList.add('show');
  document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('answerModal').classList.remove('show');
    idx++;
    idx < questions.length ? showQuestion() : finishQuiz();
  };
}

function finishQuiz() {
  document.getElementById('quiz-card').style.display = 'none';
  document.getElementById('result-card').style.display = 'block';

  const percentage = (score / questions.length) * 100;
  let emoji = percentage >= 90 ? 'üèÜ' : percentage >= 60 ? 'ü•à' : 'üëç';
  
  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultMessage').innerHTML = `<strong style="font-size:24px">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${score}/${questions.length} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong>`;

  const params = [
    'action=recordResult',
    `userId=${encodeURIComponent(userProfile.userId)}`,
    `name=${encodeURIComponent(_name)}`,
    `level=${currentQuizLevel}`,
    `score=${score}`,
    `wrong_ids=${encodeURIComponent(wrongs.join(','))}`,
    'callback=handleRecordResult'
  ];
  const script = document.createElement('script');
  script.src = `${GAS_URL}?${params.join('&')}`;
  document.head.appendChild(script);
}

window.handleRecordResult = (resp) => {
  if (resp?.status === 'success') {
    cachedRank = resp.rank;
    cachedTotal = resp.totalPlayers;
    document.getElementById('shareBtn').style.display = 'block';
  }
};

window.handleShareRecord = () => {
  const name = _name || userProfile.displayName;
  const pic = userProfile.pictureUrl;

  const flex = {
    type: 'flex',
    altText: `${name} ‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å`,
    contents: {
      type: 'bubble',
      size: 'kilo',
      header: {
        type: 'box',
        layout: 'vertical',
        backgroundColor: '#fffde7', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
        paddingAll: '12px',
        contents: [
          { type: 'text', text: `${name} ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å`, align: 'center', weight: 'bold', size: 'lg' }
        ]
      },
      body: {
        type: 'box',
        layout: 'vertical',
        backgroundColor: '#fffde7', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
        spacing: 'md',
        paddingAll: '12px',
        alignItems: 'center',
        contents: [
          { type: 'text', text: 'üëë', align: 'center', size: '4xl' },
          {
            type: 'box', layout: 'vertical', width: '100px', height: '100px',
            cornerRadius: '100px', margin: 'md',
            contents: [{ type: 'image', url: pic, size: 'full', aspectMode: 'cover' }]
          },
          { type: 'text', text: `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å ${score}/${questions.length}`, weight: 'bold', size: 'xl', margin: 'md' },
          { type: 'text', text: `‡πÄ‡∏Å‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${cachedRank} ‡∏à‡∏≤‡∏Å ${cachedTotal} ‡∏Ñ‡∏ô`, size: 'sm', color: '#666666' },
          { type: 'text', text: '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏£‡∏û.‡∏ó‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢',
            size: 'xs', color: '#666666', margin: 'lg', wrap: true, align: 'center' }
        ]
      },
      footer: {
        type: 'box',
        layout: 'vertical',
        backgroundColor: '#fffde7', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
        paddingAll: 'md',
        spacing: 'sm',
        contents: [
          {
            type: 'box',
            layout: 'horizontal',
            spacing: 'sm',
            contents: [
              { type: 'button', style: 'primary', color: '#1E88E5', action: { type: 'uri', label: '‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', uri: 'https://liff.line.me/2005789397-ROQvjpYk'} },
              { type: 'button', style: 'primary', color: '#ff9800', action: { type: 'uri', label: '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£', uri: 'https://liff.line.me/2005789397-WRm1lYd9'} }
            ]
          },
          {
            type: 'box',
            layout: 'horizontal',
            spacing: 'sm',
            contents: [
              { type: 'button', style: 'secondary', action: { type: 'uri', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á', uri: 'https://liff.line.me/2005789397-nebQ8oJy'} },
               {
                 type: 'box',
                 layout: 'vertical',
                 maxWidth: '48%',
                 backgroundColor: '#FFFFFF',
                 cornerRadius: 'md',
                 paddingAll: 'xs',
                 action: { type: 'uri', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', uri: 'https://liff.line.me/2005789397-RLAGXrBJ' },
                 contents: [{ type: 'text', text: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', color: '#111111', size: 'sm', align: 'center', gravity: 'center' }]
               }
            ]
          }
        ]
      }
    }
  };

  if (liff.isApiAvailable('shareTargetPicker')) {
    liff.shareTargetPicker([flex]).catch(err => console.error('Share Error', err));
  }
};


// --- Main App Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return; 
    }
    userProfile = await liff.getProfile();
    loadUserHistory();
  } catch (err) {
    document.getElementById('history-text').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
  }

  // Card click handlers
  const cardHandlers = {
    'cardGeneralQuiz': () => loadQuiz('general'),
    'cardAsmQuiz': () => loadQuiz('asm'),
    'cardGeneralLearn': () => document.getElementById('learn-card').classList.add('show'),
    'cardAsmGuide': () => document.getElementById('asm-guide').classList.add('show'),
  };

  document.querySelectorAll('.grid .card').forEach(card => {
    card.addEventListener('click', () => {
      document.querySelectorAll('.grid .card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      document.getElementById('quiz-card').style.display = 'none';
      document.getElementById('result-card').style.display = 'none';
      if (cardHandlers[card.id]) cardHandlers[card.id]();
    });
  });

  // Accordion
  document.querySelectorAll('.accordion-header').forEach(header => {
    header.addEventListener('click', () => {
      const body = header.nextElementSibling;
      header.classList.toggle('active');
      body.style.display = body.style.display === 'block' ? 'none' : 'block';
    });
  });
  
  // Link & Modal Close Buttons
  document.getElementById('openLearn').onclick = () => document.getElementById('learn-card').classList.add('show');
  document.querySelectorAll('.modal .close-btn').forEach(btn => {
    btn.onclick = () => btn.closest('.modal').classList.remove('show');
  });
  document.getElementById('shareBtn').onclick = handleShareRecord;
});
</script>

</body>
</html>