<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô Stroke</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        /* --- CSS Variables (Palette ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ) --- */
        :root { 
            --primary: #FF6B6B;   /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏î‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quiz/Alert) */
            --secondary: #4ECDC4; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Learn/Action) */
            --dark-teal: #1A535C; /* ‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å */
            --bg-color: #F9FBFD;  /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            --text-color: #444;   /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
            --font-stack: 'Kanit', sans-serif;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08); /* ‡πÄ‡∏á‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
        }
        body { 
            font-family: var(--font-stack) !important; 
            background: var(--bg-color); margin: 0; padding: 0;
            font-size: 18px; line-height: 1.5; color: var(--text-color);
            overscroll-behavior-y: contain;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; overflow-x: hidden; }
        
        /* Adjusted Headings to be cleaner */
        h1 { 
            font-size: 36px; text-align: center; color: var(--dark-teal); 
            margin: 15px 0 25px; font-weight: 600; 
            /* ‡∏•‡∏î text-shadow ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô */
            /* text-shadow: 2px 2px 0px var(--accent-1); */ 
        }
        

        /* --- Video Icons Menu (‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß, ‡∏•‡∏î Gradients) --- */
        .video-menu-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* 4 ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô 1 ‡πÅ‡∏ñ‡∏ß */
            gap: 12px; 
            margin-bottom: 25px; 
        }
        .video-btn {
            /* ‡πÄ‡∏≠‡∏≤ aspect-ratio 1:1 ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            padding: 15px 5px;
            border-radius: 16px; 
            display: flex; flex-direction: column;
            justify-content: flex-start; align-items: center;
            text-align: center; 
            font-weight: 600; font-size: 14px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
            line-height: 1.3;
            cursor: pointer; 
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none; /* ‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏ö‡∏´‡∏ô‡∏≤‡πÜ ‡∏≠‡∏≠‡∏Å */
            color: var(--dark-teal); /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô */
        }
        .video-btn:active { transform: scale(0.95); box-shadow: none; }
        .video-btn i { 
            font-size: 32px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
            margin-bottom: 8px; 
            text-shadow: none; /* ‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å */
        }

        /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡∏ô‡∏∏‡πà‡∏°‡πÜ ‡πÅ‡∏ó‡∏ô Gradient ‡∏à‡∏±‡∏î‡πÜ */
        .v-btn-1 { background: #ffecec; color: #d64545; } /* ‡πÇ‡∏ó‡∏ô‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
        .v-btn-2 { background: #e0f7fa; color: #0097a7; } /* ‡πÇ‡∏ó‡∏ô‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
        .v-btn-3 { background: #e8f5e9; color: #2e7d32; } /* ‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
        .v-btn-4 { background: #fff3e0; color: #ef6c00; } /* ‡πÇ‡∏ó‡∏ô‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô */


        /* --- Main Buttons (‡∏•‡∏î Gradients ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô) --- */
        .big-btn {
            width: 100%; padding: 20px; border-radius: 16px;
            font-size: 24px; font-weight: 600; text-align: center;
            cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* ‡πÄ‡∏á‡∏≤‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÅ‡∏ó‡∏ô gradient */
            display: flex; align-items: center; justify-content: center; gap: 15px;
            margin-bottom: 20px; color: white; border: none;
            transition: 0.2s;
        }
        .big-btn:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ Solid Color ‡∏ï‡∏≤‡∏° Palette */
        .btn-learn { 
            background: var(--secondary); /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÜ */
        }
        .btn-quiz { 
            background: var(--primary); /* ‡∏™‡πâ‡∏°‡πÅ‡∏î‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÜ */
        }
        .btn-quiz.completed { 
            background: #27ae60; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à */
            pointer-events: none; box-shadow: none; opacity: 0.9;
        }


        /* --- Lesson Carousel (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏á‡∏•‡∏á) --- */
        #lesson-section { display: none; }
        .carousel-container {
            display: flex; overflow-x: auto; scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; scroll-behavior: smooth;
            gap: 15px; padding-bottom: 20px;
        }
        .carousel-container::-webkit-scrollbar { height: 6px; }
        .carousel-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        .lesson-slide {
            flex: 0 0 95%; /* ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ 100% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏ö slide ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
            scroll-snap-align: center; background: #fff;
            border-radius: 20px; padding: 20px; box-sizing: border-box;
            /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö‡∏•‡∏á */
            border: 2px solid #eee;
            box-shadow: var(--card-shadow);
        }
        .lesson-title { font-size: 30px; font-weight: 600; color: var(--dark-teal); margin-bottom: 15px; text-align: center; }
        .lesson-image-container {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; cursor: zoom-in; position: relative;
        }
        .lesson-image { width: 100%; height: 100%; object-fit: cover; }
        .expand-hint { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px; pointer-events: none; display: flex; align-items: center; gap: 5px;}


        /* --- Expandable Content (‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏π Clean ‡∏Ç‡∏∂‡πâ‡∏ô) --- */
        details.lesson-content {
            background: #f8fdff; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
            border-radius: 12px; padding: 5px; margin-bottom: 20px;
            border: 1px solid #e0f2f1; /* ‡∏Ç‡∏≠‡∏ö‡∏ö‡∏≤‡∏á‡∏•‡∏á */
        }
        summary {
            font-size: 22px; font-weight: 600; color: var(--secondary);
            padding: 12px; cursor: pointer; outline: none; display: flex; justify-content: space-between; align-items: center;
        }
        .lesson-details-body { padding: 15px; font-size: 20px; line-height: 1.7; color: #555; }
        .lesson-details-body b { color: var(--dark-teal); font-weight: 600; }


        /* --- Inline Lesson Quiz --- */
        .lesson-quiz-container { border-top: 2px dashed #eee; padding-top: 25px; display: none; }
        .quiz-question-item { margin-bottom: 25px; background: #fff; padding: 0; border-radius: 0; }
        .quiz-q-text { font-size: 22px; font-weight: 600; color: var(--dark-teal); margin-bottom: 15px; }
        .quiz-choice {
            display: block; padding: 15px; margin: 8px 0;
            background: #f9f9f9; border: 2px solid #eee; border-radius: 12px;
            font-size: 20px; cursor: pointer; transition: 0.2s; color: #555;
        }
        .quiz-choice input { display: none; } 
        .quiz-choice.selected { border-color: var(--secondary); background: #e0f7fa; color: var(--dark-teal); font-weight: 600; }
        .quiz-choice.correct { border-color: #2ecc71 !important; background: #d5f5e3 !important; color: #1e8449; font-weight: 600; }
        .quiz-choice.wrong { border-color: #e74c3c !important; background: #fadbd8 !important; color: #c0392b; }
        
        .btn-submit-lesson { 
            background: var(--dark-teal); color: white; width: 100%; 
            padding: 18px; border-radius: 12px; font-size: 24px; font-weight: 600; border: none;
        }

        /* --- Image Modal & Share --- */
        #imageModal { 
            display: none; position: fixed; z-index: 3000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.85); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏∂‡∏ö‡πÅ‡∏™‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Blur ‡πÉ‡∏´‡πâ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥ */
        }
        #modalImage { max-width: 95%; max-height: 70vh; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; background: rgba(0,0,0,0.3); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;}
        .btn-share {
            margin-top: 25px; background: #06c755; /* LINE Brand Color */
            color: white; padding: 15px 35px; border-radius: 30px;
            font-size: 22px; font-weight: 600; display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
        }

        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--secondary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 50px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-center { text-align: center; }

    </style>
</head>
<body>

    <div class="container">
        <h1>‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô STROKE ‚ù§Ô∏è</h1>

        <div class="video-menu-grid">
            <div class="video-btn v-btn-1" onclick="sendTextMessage('‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å')">
                <i class="bi bi-music-note-beamed"></i>
                <span>‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ß‡∏µ<br>‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</span>
            </div>
            <div class="video-btn v-btn-2" onclick="sendTextMessage('‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£')">
                <i class="bi bi-question-circle-fill"></i>
                <span>‡∏™‡πÇ‡∏ï‡∏£‡∏Å<br>‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</span>
            </div>
            <div class="video-btn v-btn-3" onclick="sendTextMessage('‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å')">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span>‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<br>‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>
            </div>
            <div class="video-btn v-btn-4" onclick="sendTextMessage('‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å')">
                <i class="bi bi-heart-pulse-fill"></i>
                <span>‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥<br>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô</span>
            </div>
        </div>

        <hr style="border-top: 2px dashed #eee; margin: 25px 0;">

        <div id="btnLoadLesson" class="big-btn btn-learn" onclick="loadLessons()">
            <i class="bi bi-book-half"></i>
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å (10 ‡∏ö‡∏ó)
        </div>

        <div id="lesson-section">
            <div class="loader" id="lessonLoader"></div>
            <div class="carousel-container" id="carouselContainer">
                </div>
            <button class="big-btn" style="background:#eee; color:#777; margin-top:20px; box-shadow:none;" onclick="closeLessonSection()">‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>

        <div id="mainQuizBtnContainer">
            <div id="btnStartMainQuiz" class="big-btn btn-quiz" onclick="startMainQuiz()">
                <i class="bi bi-pencil-fill"></i>
                <span id="quizBtnText">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
        </div>

    </div> <div id="imageModal">
        <span class="modal-close" onclick="closeModal()"><i class="bi bi-x"></i></span>
        <img id="modalImage">
        <div class="btn-share" onclick="shareCurrentImage()">
            <i class="bi bi-share-fill"></i> ‡πÅ‡∏ä‡∏£‡πå‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // *** URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec'; 
        const LIFF_ID = '2005789397-ROQvjpYk';
        const LINE_OA_LINK = 'https://lin.ee/hkcrpOo';

        let userProfile = null;
        let mainTestType = 'pre'; 
        let lessonsData = []; 
        let currentShareImage = ''; 

        $(document).ready(() => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    userProfile = await liff.getProfile();
                    checkMainQuizHistory();
                }
            } catch (e) {
                // alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE: " + e); // Comment ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                console.error("LIFF Init Error", e);
            }
        }

        function sendTextMessage(text) {
            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: text }])
                    .then(() => { liff.closeWindow(); })
                    .catch((err) => { console.error('error', err); alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); });
            } else {
                alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô LINE App ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ' + text + ')');
            }
        }

        // --- Lesson & Quiz Functions (Logic ‡πÄ‡∏î‡∏¥‡∏°) ---

        function loadLessons() {
            $('#btnLoadLesson').hide();
            $('#lesson-section').fadeIn();
            $('#lessonLoader').show();
            $('#carouselContainer').empty(); 

            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getLessons' },
                success: function(data) {
                    if(data.length === 0) {
                         alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'); closeLessonSection(); return;
                    }
                    lessonsData = data;
                    renderLessons(data);
                    $('#lessonLoader').hide();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $('#lessonLoader').hide();
                    console.error("AJAX Error: ", textStatus, errorThrown);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    closeLessonSection();
                }
            });
        }

        function renderLessons(lessons) {
            let html = '';
            lessons.forEach((lesson, index) => {
                const lessonLevel = `lesson${index + 1}`;
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° span ‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô summary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î layout
                html += `
                <div class="lesson-slide" id="module-${lesson.module_id}">
                    <div class="lesson-title">${lesson.title}</div>
                    <div class="lesson-image-container" onclick="openModal('${lesson.images}')">
                        <img class="lesson-image" src="${lesson.images}" loading="lazy" alt="${lesson.title}">
                        <div class="expand-hint"><i class="bi bi-arrows-angle-expand"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢</div>
                    </div>
                    <details class="lesson-content">
                        <summary><span>‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</span> <i class="bi bi-chevron-down"></i></summary>
                        <div class="lesson-details-body">${lesson.content_html}</div>
                    </details>
                    
                    <div class="big-btn btn-quiz" style="font-size:22px; padding:15px;" onclick="loadLessonQuiz(this, '${lessonLevel}', '${lesson.module_id}')">
                        <i class="bi bi-clipboard-check-fill"></i> ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ (3 ‡∏Ç‡πâ‡∏≠)
                    </div>
                    <div class="lesson-quiz-container" id="quiz-${lessonLevel}">
                        <div class="text-center"><div class="loader" style="display:block; margin: 20px auto;"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>
                `;
            });
            $('#carouselContainer').html(html);
        }

        function closeLessonSection() {
            $('#lesson-section').hide();
            $('#btnLoadLesson').show();
            $('#carouselContainer').scrollLeft(0);
        }

        function loadLessonQuiz(btnElement, level, moduleId) {
            const quizContainer = $(btnElement).next('.lesson-quiz-container');
            $(btnElement).hide(); 
            quizContainer.show(); 

            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'getQuiz', level: level },
                success: function(questions) {
                    renderLessonQuiz(quizContainer, questions, level, moduleId);
                },
                 error: function() {
                    quizContainer.html('<div style="color:red;text-align:center;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>');
                    $(btnElement).show(); 
                }
            });
        }

        function renderLessonQuiz(container, questions, level, moduleId) {
            if (questions.length === 0) {
                container.html('<div class="text-center" style="color:#999; font-size:20px;">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö -</div>');
                return;
            }
            let html = '';
            questions.forEach((q, idx) => {
                let choices = ['choice1', 'choice2', 'choice3', 'choice4'].filter(k => q[k] && q[k].toString().trim() !== '');
                choices.sort(() => Math.random() - 0.5);

                html += `<div class="quiz-question-item" data-correct="${q.correct_choice}" data-testid="${q.test_id}">
                    <div class="quiz-q-text">${idx+1}. ${q.question}</div>`;
                choices.forEach(key => {
                    html += `<label class="quiz-choice" onclick="selectChoice(this)">
                                <input type="radio" name="q_${level}_${idx}" value="${q[key]}"> ${q[key]}
                             </label>`;
                });
                html += `</div>`;
            });
            html += `<button class="btn-submit-lesson" onclick="submitLessonQuiz(this, '${level}', ${questions.length}, '${moduleId}')">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>`;
            container.html(html);
        }

        window.selectChoice = (element) => {
           $(element).closest('.quiz-question-item').find('.quiz-choice').removeClass('selected');
           $(element).addClass('selected');
        }

        function submitLessonQuiz(btnBtn, level, fullScore, moduleId) {
            const quizContainer = $(btnBtn).parent();
            let score = 0;
            let wrongIds = [];
            let allAnswered = true;

            quizContainer.find('.quiz-question-item').each(function() {
                const correctVal = $(this).data('correct').toString().trim();
                const testId = $(this).data('testid');
                const selected = $(this).find('input:checked');
                
                if (selected.length === 0) { allAnswered = false; return false; } 

                const userVal = selected.val().toString().trim();
                const selectedLabel = selected.parent();

                if (userVal === correctVal) {
                    score++;
                    selectedLabel.addClass('correct');
                } else {
                    wrongIds.push(testId);
                    selectedLabel.addClass('wrong');
                    $(this).find(`input[value="${correctVal}"]`).parent().addClass('correct');
                }
                $(this).find('.quiz-choice').css('pointer-events', 'none');
            });

            if (!allAnswered) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

            $(btnBtn).hide(); 
            quizContainer.append(`<div style="text-align:center; font-size:28px; font-weight:600; margin:20px 0; color: var(--dark-teal);">
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span style="color:${score===fullScore?'#2ecc71':'#e74c3c'}">${score} / ${fullScore}</span>
            </div>`);
            
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: {
                    action: 'recordLessonResult', userId: userProfile.userId, name: userProfile.displayName,
                    level: level, score: score, full_score: fullScore, wrong_ids: wrongIds.join(','), moduleId: moduleId
                },
                success: (resp) => { console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
            });
        }

        // --- Modal & Share Functions ---
        function openModal(imgUrl) {
            currentShareImage = imgUrl;
            $('#modalImage').attr('src', imgUrl);
            $('#imageModal').css('display', 'flex').hide().fadeIn(300);
        }

        function closeModal() {
            $('#imageModal').fadeOut(300);
        }
        $('#imageModal').click(function(e) { if(e.target === this) closeModal(); });

        function shareCurrentImage() {
            if (!liff.isApiAvailable('shareTargetPicker')) {
                alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå"); return;
            }
            const flexMessage = {
                type: "flex",
                altText: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡∏µ‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏°‡∏≤‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö",
                contents: {
                    type: "bubble",
                    hero: { type: "image", url: currentShareImage, size: "full", aspectRatio: "1:1", aspectMode: "cover", action: { type: "uri", uri: LINE_OA_LINK } },
                    body: {
                        type: "box", layout: "vertical",
                        contents: [
                            { type: "text", text: "üëÜ ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", weight: "bold", size: "md", align: "center", color: "#1A535C" },
                            { type: "button", action: { type: "uri", label: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà LINE OA ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô Stroke", uri: LINE_OA_LINK }, style: "primary", color: "#FF6B6B", margin: "md" }
                        ]
                    }
                }
            };

            liff.shareTargetPicker([flexMessage])
                .then(res => { if (res) { closeModal(); } })
                .catch(err => { console.error('Share Error', err); closeModal(); });
        }

        // --- Main Quiz Function ---
        function checkMainQuizHistory() {
            $.ajax({
                url: GAS_URL, dataType: 'jsonp',
                data: { action: 'checkHistory', userId: userProfile.userId },
                success: function(data) {
                    if (data.hasTakenPost) {
                        mainTestType = 'completed';
                        $('#quizBtnText').html(`‚úÖ ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${data.lastScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)`);
                        $('#btnStartMainQuiz').addClass('completed').removeAttr('onclick');
                    } else {
                        mainTestType = 'pre'; 
                        $('#quizBtnText').html("‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏• (Pre/Post Test)");
                    }
                },
                error: function() { $('#quizBtnText').html("‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏•"); }
            });
        }

        function startMainQuiz() {
           if(mainTestType === 'completed') return;
           alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Quiz ‡πÄ‡∏î‡∏¥‡∏°");
           // window.location.href = "quiz.html"; 
        }

    </script>
</body>
</html>