<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á stroke</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        /* --- Global & Typography (Elderly Friendly) --- */
        :root { --primary-color: #1a237e; --secondary-color: #1e88e5; --bg-color: #f5f5f5; }
        body { 
            font-family: 'Noto Sans Thai', sans-serif !important; 
            background: var(--bg-color); 
            margin: 0; padding: 20px; 
            font-size: 22px; /* Base font ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            line-height: 1.6;
            color: #333;
        }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        h1 { font-size: 36px; text-align: center; color: var(--primary-color); margin-bottom: 30px; line-height: 1.3; }
        h2 { font-size: 28px; color: var(--primary-color); margin-bottom: 20px; }

        /* --- Loading Animation (Spinning Brain) --- */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; text-align: center; }
        #loading-text { font-size: 2rem; font-weight: bold; margin-bottom: 20px; }
        #loading-icon { font-size: 6rem; color: #ffc107; margin-bottom: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Big Buttons & Cards --- */
        .menu-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .big-btn {
            background: #fff; border: 3px solid var(--secondary-color);
            border-radius: 20px; padding: 30px 20px;
            font-size: 28px; font-weight: bold; color: var(--secondary-color);
            cursor: pointer; text-align: center; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .big-btn:active { transform: scale(0.98); }
        .big-btn.primary { background: var(--secondary-color); color: #fff; border: none; }
        .big-btn i { font-size: 40px; }

        /* --- Quiz Interface --- */
        #quiz-card, #result-card, #video-card { display: none; }
        .question { font-size: 30px; font-weight: bold; color: var(--primary-color); margin: 30px 0; }
        
        .choice-label {
            display: block; font-size: 26px; padding: 20px; 
            background: #f8f9fa; border: 2px solid #ddd; border-radius: 15px; 
            margin-bottom: 15px; cursor: pointer; transition: 0.2s;
        }
        .choice-label input { transform: scale(2.5); margin-right: 20px; }
        .choice-label.selected { background: #e3f2fd; border-color: var(--secondary-color); }
        
        #submitBtn {
            width: 100%; padding: 25px; font-size: 28px; 
            background: #28a745; color: white; border: none; border-radius: 15px; 
            margin-top: 20px; display: none; font-weight: bold;
        }

        /* --- Result --- */
        .result-emoji { font-size: 80px; margin-bottom: 20px; }
        .result-score { font-size: 40px; font-weight: bold; color: var(--primary-color); }
        
        /* --- Modal --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; }
        .modal-btn { width: 100%; padding: 20px; font-size: 24px; border-radius: 15px; border: none; margin-top: 15px; cursor: pointer; font-weight: bold; }
        .modal-btn.next { background: var(--secondary-color); color: white; }
        .modal-btn.close { background: #dc3545; color: white; }

        /* --- Link Buttons in Video Section --- */
        .video-link-btn {
            display: block; width: 100%; padding: 25px; margin-bottom: 20px;
            background: #fff3e0; border: 2px solid #ff9800; border-radius: 15px;
            text-decoration: none; color: #e65100; font-size: 24px; font-weight: bold;
            text-align: left;
        }
    </style>
</head>
<body>

    <div id="loading">
        <i id="loading-icon" class="bi bi-brain"></i>
        <div id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <div class="container">
        <div id="home-card">
            <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ<br>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Stroke</h1>
            
            <div id="user-info" style="text-align:center; font-size: 24px; margin-bottom: 30px; color: #555;">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö...
            </div>

            <div class="menu-grid">
                <div class="big-btn" onclick="showVideoLinks()">
                    <i class="bi bi-youtube"></i>
                    ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ<br>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å
                </div>

                <div id="startQuizBtn" class="big-btn primary" onclick="startQuiz()">
                    <i class="bi bi-pencil-square"></i>
                    <span id="quizBtnText">‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å</span>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px; font-size: 18px; color: #888;">
                *‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏
            </div>
        </div>

        <div id="video-card">
            <h2>‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
            <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</p>
            
            <a href="https://drive.google.com/file/d/1IyHiddZG8BLn_ztuoGNUoID4KqmrjQbG/view?usp=drive_link" target="_blank" class="video-link-btn">
                üéµ ‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å
            </a>
            
            <a href="https://drive.google.com/file/d/1T-_o8_2Zmq57epW9MsKi7hIWrLu7tErQ/view?usp=drive_link" target="_blank" class="video-link-btn">
                üöë ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å
            </a>

            <button class="modal-btn close" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <div id="quiz-card">
            <div style="font-size: 24px; font-weight: bold; color: #666; margin-bottom: 10px;">
                <span id="testTypeLabel">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>
                <span style="float:right;" id="qIndex">1/10</span>
            </div>
            <div id="questionText" class="question">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
            <div id="choicesContainer"></div>
            <button id="submitBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>

        <div id="result-card" style="text-align: center;">
            <div id="resultEmoji" class="result-emoji">üèÜ</div>
            <div style="font-size: 28px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div id="resultScore" class="result-score">0/10</div>
            <p id="resultDesc" style="font-size: 24px; margin-top: 20px;"></p>
            
            <button class="modal-btn next" onclick="closeApp()">‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</button>
        </div>
    </div>

    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <div id="fbEmoji" style="font-size: 60px;"></div>
            <div id="fbTitle" style="font-size: 32px; font-weight: bold; margin: 10px 0;"></div>
            <div id="fbMsg" style="font-size: 24px; text-align: left; margin-top: 15px;"></div>
            <button id="nextQBtn" class="modal-btn next">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwt4O6aTK_NqGGdYaIF6gRbv5f37dgFeQYZ7ZLxZIRYGBEz54EnJx1hS36XPhET1AOgHg/exec'; // **‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡πâ‡∏≤ Deploy ‡πÉ‡∏´‡∏°‡πà**
        const LIFF_ID = '2005789397-ROQvjpYk';

        let userProfile = null;
        let testType = 'pre'; // 'pre' or 'post'
        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let wrongAnswers = [];
        let userName = '';

        // --- Initialization ---
        $(document).ready(() => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    userProfile = await liff.getProfile();
                    checkUserHistory();
                }
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE");
                $('#loading').hide();
            }
        }

        function checkUserHistory() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏∏‡πà‡∏° Pre/Post
            $.ajax({
                url: GAS_URL,
                dataType: 'jsonp',
                data: {
                    action: 'checkHistory',
                    userId: userProfile.userId
                },
                success: function(data) {
                    $('#loading').hide();
                    userName = data.name || userProfile.displayName;
                    $('#user-info').html(`‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <strong>${userName}</strong>`);

                    if (data.hasTaken) {
                        testType = 'post';
                        $('#quizBtnText').html("‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Post-test)");
                    } else {
                        testType = 'pre';
                        $('#quizBtnText').html("‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Pre-test)");
                    }
                },
                error: function() {
                    $('#loading').hide();
                    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
                }
            });
        }

        // --- UI Navigation ---
        window.showVideoLinks = () => {
            $('#home-card').hide();
            $('#video-card').show();
        };

        window.startQuiz = () => {
            $('#home-card').hide();
            $('#loading').css('display', 'flex'); // Show loading
            
            // Load ASM questions
            $.ajax({
                url: GAS_URL,
                dataType: 'jsonp',
                data: {
                    action: 'getQuiz',
                    level: 'asm' // Hardcode type as ASM
                },
                success: function(data) {
                    $('#loading').hide();
                    questions = data;
                    currentIdx = 0;
                    score = 0;
                    wrongAnswers = [];
                    
                    $('#quiz-card').show();
                    $('#testTypeLabel').text(testType === 'pre' ? "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
                    renderQuestion();
                }
            });
        };

        // --- Quiz Logic ---
        function renderQuestion() {
            const q = questions[currentIdx];
            $('#qIndex').text(`${currentIdx + 1} / ${questions.length}`);
            $('#questionText').text(q.question);
            
            // Random Choices
            let choices = ['choice1', 'choice2', 'choice3', 'choice4'];
            choices.sort(() => Math.random() - 0.5);

            let html = '';
            choices.forEach(key => {
                if(q[key]) {
                    html += `<label class="choice-label">
                                <input type="radio" name="ans" value="${q[key]}">
                                ${q[key]}
                             </label>`;
                }
            });
            $('#choicesContainer').html(html);
            $('#submitBtn').hide();

            // Select Event
            $('.choice-label').click(function() {
                $('.choice-label').removeClass('selected');
                $(this).addClass('selected');
                $(this).find('input').prop('checked', true);
                $('#submitBtn').show();
            });

            // Bind Submit
            $('#submitBtn').off('click').click(() => checkAnswer(q));
        }

        function checkAnswer(q) {
            const selectedVal = $('input[name="ans"]:checked').val();
            const correctVal = q.correct_choice.trim();
            const isCorrect = (selectedVal.trim() === correctVal);

            if (isCorrect) {
                score++;
                showFeedback(true, correctVal);
            } else {
                wrongAnswers.push(q.test_id);
                showFeedback(false, correctVal);
            }
        }

        function showFeedback(isCorrect, answerText) {
            $('#fbEmoji').text(isCorrect ? '‚úÖ' : '‚ùå');
            $('#fbTitle').text(isCorrect ? '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!' : '‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö');
            $('#fbTitle').css('color', isCorrect ? 'green' : 'red');
            
            if(!isCorrect) {
                $('#fbMsg').html(`‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠:<br><strong>${answerText}</strong>`);
            } else {
                $('#fbMsg').text('');
            }

            $('#feedbackModal').addClass('show');
            
            $('#nextQBtn').off('click').click(() => {
                $('#feedbackModal').removeClass('show');
                currentIdx++;
                if(currentIdx < questions.length) {
                    renderQuestion();
                } else {
                    finishQuiz();
                }
            });
        }

        function finishQuiz() {
            $('#quiz-card').hide();
            $('#loading').css('display', 'flex');

            // Save Result
            $.ajax({
                url: GAS_URL,
                dataType: 'jsonp',
                data: {
                    action: 'recordResult',
                    userId: userProfile.userId,
                    name: userName,
                    level: 'asm', // Always ASM
                    score: score,
                    full_score: questions.length,
                    wrong_ids: wrongAnswers.join(','),
                    test_type: testType // pre or post
                },
                success: function(resp) {
                    $('#loading').hide();
                    $('#result-card').show();
                    $('#resultScore').text(`${score} / ${questions.length}`);
                    
                    if(testType === 'pre') {
                        $('#resultDesc').text("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                    } else {
                        $('#resultDesc').text("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    }
                }
            });
        }

        window.closeApp = () => {
            if(liff.isInClient()) {
                liff.closeWindow();
            } else {
                location.reload();
            }
        }

    </script>
</body>
</html>